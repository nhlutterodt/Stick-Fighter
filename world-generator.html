<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Procedural World Generator</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #controls-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(40, 40, 40, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
            max-height: 90vh;
            overflow-y: auto;
            width: 360px; 
        }
        .control-group {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        .control-group:last-child {
            border-bottom: none;
        }
        h3 {
            color: #61dafb;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }
        input[type="range"], input[type="number"], select, input[type="checkbox"] {
            width: calc(100% - 20px);
            padding: 8px 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
            box-sizing: border-box;
        }
        input[type="range"] { padding: 0; }
        input[type="checkbox"] { width: auto; margin-right: 5px; vertical-align: middle;}

        button, .file-input-label { 
            background-color: #555; 
            color: #e0e0e0;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease;
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
            display: inline-block; 
            text-align: center; 
            font-size: 1em; 
            line-height: normal; 
        }
        button:hover, .file-input-label:hover { background-color: #777; }
        button.action-button { background-color: #61dafb; color: #1a1a1a; }
        button.action-button:hover { background-color: #82eaff; }
        button.secondary, .file-input-label.secondary { background-color: #4CAF50; color: white; }
        button.secondary:hover, .file-input-label.secondary:hover { background-color: #66bb6a; }
        button.gemini-button { background-color: #8A2BE2; color: white; }
        button.gemini-button:hover { background-color: #9932CC; }
        button.theme-button { background-color: #3f51b5; color: white; }
        button.theme-button:hover { background-color: #5c6bc0; }
        input[type="file"] { display: none; }
        .tool-button, .world-terrain-button { width: calc(50% - 5px); margin-bottom: 5px; padding: 8px 10px; font-size: 0.9em; }
        .world-terrain-button { width: auto; margin-right: 5px; }
        .tool-button.active { background-color: #61dafb; color: #1a1a1a; border: 2px solid #fff; }
        .button-row { display: flex; justify-content: space-between; flex-wrap: wrap; }
        #worldTerrainList div { background-color: #333; padding: 8px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #444; }
        #worldTerrainList div.active-terrain-item { border-color: #61dafb; box-shadow: 0 0 5px #61dafb; }
        #worldTerrainList label { font-size: 0.8em; margin-right: 5px; }
        #worldTerrainList input[type="number"] { width: 60px; padding: 4px; margin-right: 5px; font-size: 0.9em; }
        #info { position: absolute; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 3px; font-size: 0.8em; }
        #loading-indicator, #gemini-loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5em; color: #fff; background-color: rgba(0,0,0,0.7); padding: 20px; border-radius: 8px; display: none; z-index: 100; }
        canvas { display: block; cursor: default; } 
        .critical-error-message { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background-color:rgba(220,53,69,0.9); color:white; padding:10px 15px; border-radius:5px; z-index:10000; font-size: 0.9em; box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align:center; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #282828; color: #e0e0e0; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid #444; font-size: 1.2em; color: #61dafb; }
        .modal-body { padding-top: 10px; line-height: 1.6; max-height: 300px; overflow-y: auto;}
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: #fff; text-decoration: none; cursor: pointer; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="controls-container">
        <div class="control-group">
            <h3>Active Terrain Config</h3>
            <label for="terrainWidth">Width: <span id="terrainWidthVal">200</span>m</label>
            <input type="range" id="terrainWidth" min="50" max="500" value="200" step="10">
            <label for="terrainDepth">Depth: <span id="terrainDepthVal">200</span>m</label>
            <input type="range" id="terrainDepth" min="50" max="500" value="200" step="10">
            <label for="segments">Segments: <span id="segmentsVal">100</span></label>
            <input type="range" id="segments" min="20" max="250" value="100" step="5">
            <label for="terrainThickness">Thickness: <span id="terrainThicknessVal">10</span>m</label>
            <input type="range" id="terrainThickness" min="0" max="50" value="10" step="1">
            <button id="generateLoreButton" class="gemini-button">✨ Generate Custom Lore</button>
        </div>

         <div class="control-group">
            <h3>Default Lore & Terrain Themes</h3>
            <div class="button-row">
                <button class="theme-button" data-theme="mystic_mountains">Mystic Peaks</button>
                <button class="theme-button" data-theme="forgotten_desert">Forgotten Desert</button>
            </div>
            <div class="button-row">
                <button class="theme-button" data-theme="sunken_ruins">Sunken Ruins</button>
                <button class="theme-button" data-theme="crystal_caves">Crystal Caves</button>
            </div>
        </div>

        <div class="control-group">
            <h3>Active Terrain Noise</h3>
            <label for="noiseScale">Scale: <span id="noiseScaleVal">70</span></label>
            <input type="range" id="noiseScale" min="10" max="200" value="70" step="1">
            <label for="terrainHeightScale">Max Height: <span id="terrainHeightScaleVal">30</span>m</label>
            <input type="range" id="terrainHeightScale" min="5" max="100" value="30" step="1">
            <label for="octaves">Octaves: <span id="octavesVal">4</span></label>
            <input type="range" id="octaves" min="1" max="8" value="4" step="1">
            <label for="persistence">Persistence: <span id="persistenceVal">0.5</span></label>
            <input type="range" id="persistence" min="0.1" max="1" value="0.5" step="0.05">
            <label for="lacunarity">Lacunarity: <span id="lacunarityVal">2.0</span></label>
            <input type="range" id="lacunarity" min="1.5" max="4" value="2.0" step="0.1">
        </div>

        <div class="control-group">
            <h3>Active Terrain Features</h3>
            <label for="plateauLevel">Plateau Level: <span id="plateauLevelVal">0.0</span></label>
            <input type="range" id="plateauLevel" min="0" max="1" value="0.0" step="0.05">
            <label for="plateauSmoothing">Plateau Smooth: <span id="plateauSmoothingVal">0.1</span></label>
            <input type="range"id="plateauSmoothing" min="0.01" max="0.5" value="0.1" step="0.01">
            <label for="valleyDepthFactor">Valley Depth: <span id="valleyDepthFactorVal">1.5</span></label>
            <input type="range" id="valleyDepthFactor" min="1.0" max="5.0" value="1.5" step="0.1">
            <label for="valleyThreshold">Valley Thresh: <span id="valleyThresholdVal">-0.2</span></label>
            <input type="range" id="valleyThreshold" min="-1" max="0" value="-0.2" step="0.05">
            <label for="waterLevel">Water Level: <span id="waterLevelVal">0</span>m</label>
            <input type="range" id="waterLevel" min="-50" max="50" value="0" step="1">
        </div>
        
        <div class="control-group">
            <h3>Grid Settings</h3>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <label for="showGridInput" style="margin-bottom: 0; margin-right: 5px;">Show Grid: </label>
                <input type="checkbox" id="showGridInput" style="margin-bottom: 0;">
                <label for="snapYToGridInput" style="margin-bottom: 0; margin-left: 15px; margin-right: 5px;">Snap Y Offset: </label>
                <input type="checkbox" id="snapYToGridInput" style="margin-bottom: 0;">
            </div>
            <label for="gridCellSize">Cell Size: <span id="gridCellSizeVal">10</span>m</label>
            <input type="range" id="gridCellSize" min="5" max="100" value="10" step="5">
            <label for="gridDisplaySize">Grid Size: <span id="gridDisplaySizeVal">1000</span>m</label>
            <input type="range" id="gridDisplaySize" min="100" max="2000" value="1000" step="100">
        </div>

        <div class="control-group">
            <h3>Camera Controls</h3>
            <button id="resetCameraButton">Reset Camera</button>
            <label for="minDistance">Min Zoom: <span id="minDistanceVal">20</span>m</label>
            <input type="range" id="minDistance" min="1" max="100" value="20" step="1">
            <label for="maxDistance">Max Zoom: <span id="maxDistanceVal">500</span>m</label>
            <input type="range" id="maxDistance" min="100" max="1000" value="500" step="10">
        </div>

        <div class="control-group">
            <h3>Tools (for Active Terrain)</h3>
            <button class="tool-button" id="navigateToolButton" data-tool="NONE">Navigate</button>
            <button class="tool-button" id="moveTerrainToolButton" data-tool="MOVE_TERRAIN">Move Active Terrain</button>
            <hr style="margin: 10px 0; border-color: #444;">
            <label for="brushSize">Brush Size: <span id="brushSizeVal">10</span>m</label>
            <input type="range" id="brushSize" min="1" max="50" value="10" step="1">
            <label for="sculptStrength" style="margin-top:10px;">Sculpt Strength: <span id="sculptStrengthVal">0.5</span>m</label>
            <input type="range" id="sculptStrength" min="0.1" max="2" value="0.5" step="0.1">
            <div class="button-row">
                <button class="tool-button" data-tool="SCULPT_RAISE">Raise</button>
                <button class="tool-button" data-tool="SCULPT_LOWER">Lower</button>
            </div>
            <hr style="margin: 10px 0; border-color: #444;">
            <div class="button-row">
                <button class="tool-button" data-tool="PAINT" data-type="GRASS">Grass</button>
                <button class="tool-button" data-tool="PAINT" data-type="SAND">Sand</button>
            </div>
            <div class="button-row">
                 <button class="tool-button" data-tool="PAINT" data-type="ROCK">Rock</button>
                 <button class="tool-button" data-tool="PAINT" data-type="SNOW">Snow</button>
            </div>
             <div class="button-row">
                <button class="tool-button" data-tool="PAINT" data-type="LAVA">Lava</button>
                <button class="tool-button" data-tool="PAINT" data-type="GRAVEL">Gravel</button>
            </div>
        </div>
        
        <div class="control-group">
            <h3>World Management</h3>
            <label for="addTerrainInput" class="file-input-label secondary">Add Terrain From File</label>
            <input type="file" id="addTerrainInput" accept=".json">
            <button id="regenerateActiveButton" class="action-button">Regenerate Active Terrain</button>
            <button id="saveActiveTerrainButton" class="secondary">Save Active Terrain</button>
            <hr style="margin: 10px 0; border-color: #444;">
            <label for="loadWorldInput" class="file-input-label">Load World</label>
            <input type="file" id="loadWorldInput" accept=".world.json">
            <button id="saveWorldButton" class="secondary">Save World</button>
            <div id="worldTerrainList" style="margin-top:10px; max-height: 150px; overflow-y:auto; border: 1px solid #555; padding:5px;">
                </div>
        </div>
    </div>

    <div id="loading-indicator">Generating Terrain...</div>
    <div id="gemini-loading-indicator">✨ Generating Lore...</div>

    <div id="loreModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <span class="close-button" id="closeLoreModal">&times;</span> <h2>Terrain Lore</h2> </div> <div class="modal-body"> <p id="loreText">Loading lore...</p> </div> </div> </div>
    <div id="info">Double-click terrain to focus. Left-click to paint/sculpt/move. Right-click to pan. (Units are in meters)</div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script>console.log('Diag three.js: typeof window.THREE =', typeof window.THREE);</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
    <script>console.log('Diag simplex-noise: typeof window.SimplexNoise =', typeof window.SimplexNoise);</script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script>console.log('Diag OrbitControls: typeof window.THREE?.OrbitControls =', typeof window.THREE?.OrbitControls);</script>

    <script> 
        // --- Global Scope Variables ---
        let scene, camera, renderer, controls;
        let simplex; 
        let worldTerrains = []; 
        let activeTerrainIndex = -1; 
        let worldGroup, gridHelperVisual; 
        let groundPlane; 

        const loadingIndicator = document.getElementById('loading-indicator');
        const geminiLoadingIndicator = document.getElementById('gemini-loading-indicator');
        const loreModal = document.getElementById('loreModal');
        const closeLoreModalButton = document.getElementById('closeLoreModal');
        const loreTextElement = document.getElementById('loreText');
        let animationFrameCount = 0; 

        const TOOL_MODES = { NONE: 'NONE', PAINT: 'PAINT', SCULPT_RAISE: 'SCULPT_RAISE', SCULPT_LOWER: 'SCULPT_LOWER', MOVE_TERRAIN: 'MOVE_TERRAIN' };
        const TERRAIN_TYPES = { SAND: 0, GRASS: 1, ROCK: 2, SNOW: 3, LAVA: 4, GRAVEL: 5 };
        const TERRAIN_COLORS = {[TERRAIN_TYPES.SAND]:new THREE.Color(0xC2B280),[TERRAIN_TYPES.GRASS]:new THREE.Color(0x559955),[TERRAIN_TYPES.ROCK]:new THREE.Color(0x888888),[TERRAIN_TYPES.SNOW]:new THREE.Color(0xFFFFFF),[TERRAIN_TYPES.LAVA]:new THREE.Color(0xFF4500),[TERRAIN_TYPES.GRAVEL]:new THREE.Color(0xA9A9A9)};
        const SIDE_BOTTOM_COLOR = new THREE.Color(0x654321);
        const PLACED_OBJECT_TYPES = { TREE: 'tree', ROCK_OBJ: 'rock_obj' };
        
        let currentToolMode = TOOL_MODES.NONE;
        let currentPaintType = TERRAIN_TYPES.GRASS;
        let brushSize = 10; 
        let sculptStrength = 0.5; 
        let isInteracting = false; 
        let isMovingTerrainState = false; 
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        const initialCameraPosition = new THREE.Vector3(80, 80, 80);
        const initialCameraTarget = new THREE.Vector3(0, 0, 0);
        let newTargetPosition = null; 
        let isFocusTransitioning = false;
        const focusSmoothingFactor = 0.08;

        const defaultConfig = {
            terrainWidth: 200, terrainDepth: 200, segments: 100, terrainThickness: 10,
            noiseScale: 70, terrainHeightScale: 30, octaves: 4, persistence: 0.5, lacunarity: 2.0,
            plateauLevel: 0.0, plateauSmoothing: 0.1, valleyDepthFactor: 1.5, valleyThreshold: -0.2, 
            waterLevel: 0,
            treePlacementProbability: 0.02, rockPlacementProbability: 0.01,
            minDistance: 20, maxDistance: 500,
            gridCellSize: 10, gridDisplaySize: 1000, showGrid: true, snapYToGrid: false,
        };
        
        const LORE_THEMES = { /* ... (minified for brevity) ... */ };
        
        // --- Initialization Functions ---
        function initThreeJSCore() {
            if (typeof THREE === 'undefined') throw new Error("THREE undefined.");
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 100, 600);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);
            worldGroup = new THREE.Group();
            scene.add(worldGroup);
            groundPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            console.log("LOG: Three.js Core Initialized.");
        }

        function initExternalLibraries() {
            try {
                if (typeof window.SimplexNoise === 'function') simplex = new window.SimplexNoise();
                else throw new Error("SimplexNoise not constructor.");
            } catch (e) {
                displayGlobalError(`CRIT:Simplex:${e.message}`, "simplex-err");
                simplex = { noise2D: () => 0 }; // Fallback
            }
            console.log("LOG: External Libraries Initialized (SimplexNoise).");
        }

        function initLighting() {
            const ambL = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambL);
            const dirL = new THREE.DirectionalLight(0xffffff, 0.8);
            dirL.position.set(50, 100, 50); dirL.castShadow = true;
            dirL.shadow.mapSize.set(2048, 2048); scene.add(dirL);
            console.log("LOG: Lighting Initialized.");
        }

        function initControls() {
            try {
                if (THREE && typeof THREE.OrbitControls === 'function') {
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true; controls.dampingFactor = 0.05;
                    controls.screenSpacePanning = true;
                    controls.minDistance = defaultConfig.minDistance;
                    controls.maxDistance = defaultConfig.maxDistance;
                    resetCamera(); // Set initial position and target
                } else throw new Error("OrbitControls not found on THREE object.");
            } catch (e) {
                displayGlobalError(`CRIT:OrbitControls:${e.message}`, "orbitctrl-err");
            }
            console.log("LOG: OrbitControls Initialized.");
        }
        
        function initEventListeners() {
            renderer.domElement.addEventListener('mousedown', onTerrainMouseDown);
            renderer.domElement.addEventListener('mousemove', onTerrainMouseMove);
            renderer.domElement.addEventListener('mouseup', onTerrainMouseUp);
            renderer.domElement.addEventListener('dblclick', onTerrainDoubleClick);
            renderer.domElement.addEventListener('contextmenu', e => e.preventDefault());
            window.addEventListener('resize', onWindowResize);
            if(closeLoreModalButton) closeLoreModalButton.onclick = function() { loreModal.style.display = "none"; }
            if(loreModal) window.onclick = function(event) { if (event.target == loreModal) { loreModal.style.display = "none"; } }
            console.log("LOG: Global Event Listeners Initialized.");
        }

        function initDefaultWorldState() {
            if (worldTerrains.length === 0) {
                console.log("LOG: init() - No terrains exist, creating a default initial terrain.");
                const newTerrainId = `terrain_init_${Date.now()}`;
                const newTerrainInstance = createNewTerrainInstance(newTerrainId, JSON.parse(JSON.stringify(defaultConfig)), {x:0, y:0, z:0});
                worldTerrains.push(newTerrainInstance);
                activeTerrainIndex = 0;
                showLoading();
                setTimeout(() => {
                    createOrUpdateTerrainInstance(newTerrainInstance, null, null);
                    placeObjects(newTerrainInstance);
                    hideLoading();
                    renderWorldTerrainList();
                    updateUIForActiveTerrain();
                }, 50);
            } else {
                updateUIForActiveTerrain(); // If loading a world, this will be called again
                renderWorldTerrainList();
            }
        }

        function init() {
            console.log("LOG: Main init() sequence started.");
            initThreeJSCore();
            initExternalLibraries();
            initLighting();
            initControls(); // Depends on camera & renderer from initThreeJSCore
            initEventListeners();
            setupUI(); // Sets up UI event listeners and initial tool state
            updateGridHelper(); // Initialize grid visibility based on defaultConfig
            initDefaultWorldState(); // Creates initial terrain or updates UI if world loaded
            animate();
            console.log("LOG: Main init() sequence finished.");
        }

        // --- UI Helper Functions ---
        function updateGridHelper() { /* Unchanged */ if(gridHelperVisual)scene.remove(gridHelperVisual);if(defaultConfig.showGrid&&THREE){gridHelperVisual=new THREE.GridHelper(defaultConfig.gridDisplaySize,defaultConfig.gridDisplaySize/defaultConfig.gridCellSize);scene.add(gridHelperVisual);}}
        function setupUI() { /* Unchanged - but ensure defaultConfig is used for initial values */
            const uiInputs = ['terrainWidth','terrainDepth','segments','terrainThickness','noiseScale','terrainHeightScale','octaves','persistence','lacunarity','plateauLevel','plateauSmoothing','valleyDepthFactor','valleyThreshold','waterLevel','brushSize','sculptStrength','minDistance','maxDistance', 'gridCellSize', 'gridDisplaySize'];
            uiInputs.forEach(id=>{const iEl=document.getElementById(id),vEl=document.getElementById(id+'Val');if(iEl){let initVal;if(id==='brushSize')initVal=brushSize;else if(id==='sculptStrength')initVal=sculptStrength;else initVal=defaultConfig[id];iEl.value=initVal;if(vEl)vEl.textContent=initVal;iEl.addEventListener('input',e=>{const pVal=parseFloat(e.target.value);const aT=getActiveTerrain();if(id==='brushSize')brushSize=pVal;else if(id==='sculptStrength')sculptStrength=pVal;else if(id==='gridCellSize'||id==='gridDisplaySize'){defaultConfig[id]=pVal;updateGridHelper();}else if(aT){if(id==='segments'||id==='octaves')aT.config[id]=parseInt(e.target.value);else aT.config[id]=pVal;}if(vEl)vEl.textContent=e.target.value;if(controls){if(aT && id==='minDistance')aT.config.minDistance=controls.minDistance=pVal;if(aT && id==='maxDistance')aT.config.maxDistance=controls.maxDistance=pVal;}if(id==='terrainThickness'&&aT){aT.config.terrainThickness=pVal;regenerateActiveTerrain();}});}});
            const showGridCheckbox = document.getElementById('showGridInput'); if (showGridCheckbox) {showGridCheckbox.checked = defaultConfig.showGrid;showGridCheckbox.addEventListener('change', (e) => {defaultConfig.showGrid = e.target.checked;updateGridHelper();});}
            const snapYToGridCheckbox = document.getElementById('snapYToGridInput'); if (snapYToGridCheckbox) { snapYToGridCheckbox.checked = defaultConfig.snapYToGrid; snapYToGridCheckbox.addEventListener('change', (e) => { defaultConfig.snapYToGrid = e.target.checked; }); }
            document.getElementById('regenerateActiveButton')?.addEventListener('click',regenerateActiveTerrain);document.getElementById('saveActiveTerrainButton')?.addEventListener('click',saveActiveTerrainData);document.getElementById('addTerrainInput')?.addEventListener('change',addTerrainFromFile);document.getElementById('resetCameraButton')?.addEventListener('click',resetCamera);document.getElementById('saveWorldButton')?.addEventListener('click',saveWorldData);document.getElementById('loadWorldInput')?.addEventListener('change',loadWorldData);document.getElementById('generateLoreButton')?.addEventListener('click',()=>handleGenerateLoreClick());
            document.querySelectorAll('.theme-button').forEach(b=>{b.addEventListener('click',()=>{applyLoreTheme(b.dataset.theme);});});
            const toolBtns=document.querySelectorAll('.tool-button'),navBtn=document.getElementById('navigateToolButton');
            function setActiveToolButton(actBtn){toolBtns.forEach(b=>b.classList.remove('active'));if(actBtn)actBtn.classList.add('active');if(renderer&&renderer.domElement)renderer.domElement.style.cursor=(currentToolMode!==TOOL_MODES.NONE)?(currentToolMode === TOOL_MODES.MOVE_TERRAIN ? 'move' : 'crosshair'):'default';if(controls && THREE){controls.mouseButtons.LEFT=(currentToolMode===TOOL_MODES.NONE)?THREE.MOUSE.ROTATE:-1;controls.mouseButtons.RIGHT=THREE.MOUSE.PAN;controls.mouseButtons.MIDDLE=THREE.MOUSE.DOLLY;}}
            toolBtns.forEach(b=>{b.addEventListener('click',()=>{const t=b.dataset.tool,type=b.dataset.type;currentToolMode=TOOL_MODES[t]||TOOL_MODES.NONE;setActiveToolButton(b);if(currentToolMode===TOOL_MODES.PAINT)currentPaintType=TERRAIN_TYPES[type];});});
            if(navBtn)setActiveToolButton(navBtn);
        }
        function applyLoreTheme(themeKey) { /* Minified */ const t=LORE_THEMES[themeKey];if(!t){displayGlobalError(`Theme "${themeKey}" NF.`,"theme-nf");return;}let aT=getActiveTerrain();if(!aT){const nTI=createNewTerrainInstance(`t_theme_${themeKey}_${Date.now()}`,{...defaultConfig,...t.config},{x:0,y:0,z:0});worldTerrains.push(nTI);activeTerrainIndex=worldTerrains.length-1;aT=nTI;}else{aT.config={...aT.config,...t.config};}updateUIForActiveTerrain();showLoading();setTimeout(()=>{createOrUpdateTerrainInstance(aT,null,null);placeObjects(aT);hideLoading();renderWorldTerrainList();handleGenerateLoreClick(t.lorePrompt);},50);}
        function resetCamera(){if(camera&&controls){camera.position.copy(initialCameraPosition);controls.target.copy(initialCameraTarget);controls.update();newTargetPosition=null;isFocusTransitioning=false;}}
        function showLoading(isGemini=false){if(isGemini&&geminiLoadingIndicator)geminiLoadingIndicator.style.display='block';else if(!isGemini&&loadingIndicator)loadingIndicator.style.display='block';}
        function hideLoading(isGemini=false){if(isGemini&&geminiLoadingIndicator)geminiLoadingIndicator.style.display='none';else if(!isGemini&&loadingIndicator)loadingIndicator.style.display='none';}
        function displayGlobalError(msg,id='gen-err'){const eId=`${id}-msg`;let eD=document.getElementById(eId);if(!eD){eD=document.createElement('div');eD.id=eId;eD.className='critical-error-message';document.body.appendChild(eD);}eD.textContent=msg;console.error(`ERR[${id}]:${msg}`);}
        function updateUIForActiveTerrain(){const aT=getActiveTerrain(),sC=aT?aT.config:defaultConfig,tS=aT?aT.toolSettings:{brushSize,sculptStrength,currentToolMode,currentPaintType};for(const k in sC){if(sC.hasOwnProperty(k)){const iE=document.getElementById(k),vE=document.getElementById(k+'Val');if(iE)iE.value=sC[k];if(vE)vE.textContent=sC[k];if(controls&&(k==='minDistance'||k==='maxDistance'))controls[k]=sC[k];}}document.getElementById('brushSize').value=tS.brushSize??brushSize;document.getElementById('brushSizeVal').textContent=tS.brushSize??brushSize;document.getElementById('sculptStrength').value=tS.sculptStrength??sculptStrength;document.getElementById('sculptStrengthVal').textContent=tS.sculptStrength??sculptStrength;
        const gcsI=document.getElementById('gridCellSize');if(gcsI)gcsI.value=defaultConfig.gridCellSize;const gcsV=document.getElementById('gridCellSizeVal');if(gcsV)gcsV.textContent=defaultConfig.gridCellSize;
        const gdsI=document.getElementById('gridDisplaySize');if(gdsI)gdsI.value=defaultConfig.gridDisplaySize;const gdsV=document.getElementById('gridDisplaySizeVal');if(gdsV)gdsV.textContent=defaultConfig.gridDisplaySize;
        const sgI=document.getElementById('showGridInput');if(sgI)sgI.checked=defaultConfig.showGrid;
        const syI=document.getElementById('snapYToGridInput');if(syI)syI.checked=defaultConfig.snapYToGrid;
        document.querySelectorAll('.tool-button').forEach(b=>b.classList.remove('active'));let actBtn;const mTS=aT?(tS.currentToolMode||TOOL_MODES.NONE):currentToolMode,pTTS=aT?(tS.currentPaintType||TERRAIN_TYPES.GRASS):currentPaintType;if(mTS===TOOL_MODES.PAINT){const tk=Object.keys(TERRAIN_TYPES).find(k=>TERRAIN_TYPES[k]===pTTS);actBtn=document.querySelector(`.tool-button[data-tool="PAINT"][data-type="${tk}"]`);}else if(mTS!==TOOL_MODES.NONE)actBtn=document.querySelector(`.tool-button[data-tool="${mTS}"]`);else actBtn=document.getElementById('navigateToolButton');if(actBtn)actBtn.classList.add('active');else if(document.getElementById('navigateToolButton'))document.getElementById('navigateToolButton').classList.add('active');if(aT&&tS){currentToolMode=tS.currentToolMode||TOOL_MODES.NONE;currentPaintType=tS.currentPaintType||TERRAIN_TYPES.GRASS;brushSize=tS.brushSize||10;sculptStrength=tS.sculptStrength||0.5;}if(renderer&&renderer.domElement)renderer.domElement.style.cursor=(currentToolMode!==TOOL_MODES.NONE)?(currentToolMode===TOOL_MODES.MOVE_TERRAIN?'move':'crosshair'):'default';if(controls&&THREE)controls.mouseButtons.LEFT=(currentToolMode===TOOL_MODES.NONE)?THREE.MOUSE.ROTATE:-1;}

        // --- Terrain Instance Creation ---
        function createNewTerrainInstance(id, initialConfig, offset) {
            const newInstance = {
                id: id,
                config: JSON.parse(JSON.stringify(initialConfig)), // Deep copy
                geometryData: null, // Will be populated by createOrUpdateTerrainInstance
                placedObjectsData: [],
                offset: { ...offset }, // Copy offset
                mesh: null,
                waterMesh: null,
                objectsGroup: new THREE.Group(), // Each instance has its own object group
                vertexTerrainTypes: [], // Specific to this instance
                toolSettings: { // Default tool settings for a new instance
                    brushSize: brushSize, // Or a default like 10
                    sculptStrength: sculptStrength, // Or a default like 0.5
                    currentToolMode: TOOL_MODES.NONE,
                    currentPaintType: TERRAIN_TYPES.GRASS
                }
            };
            newInstance.objectsGroup.position.set(newInstance.offset.x, newInstance.offset.y, newInstance.offset.z);
            worldGroup.add(newInstance.objectsGroup);
            return newInstance;
        }
        
        // --- Terrain Generation, Interaction, Placement, Save/Load (Minified for brevity) ---
        function getNoise(x,y,s,o,p,l){let t=0,f=1,a=1,m=0;for(let i=0;i<o;i++){if(simplex&&typeof simplex.noise2D==='function')t+=simplex.noise2D(x*f/s,y*f/s)*a;else return 0;m+=a;a*=p;f*=l;}return m===0?0:t/m;}
        function createOrUpdateTerrainInstance(tI,lTSP=null,lTTA=null){if(!scene||!THREE)return;if(tI.mesh){worldGroup.remove(tI.mesh);tI.mesh.geometry.dispose();tI.mesh.material.dispose();tI.mesh=null;}if(tI.waterMesh){worldGroup.remove(tI.waterMesh);tI.waterMesh.geometry.dispose();tI.waterMesh.material.dispose();tI.waterMesh=null;}const cC=tI.config,wS=cC.segments,hS=cC.segments,nTV=(wS+1)*(hS+1);const fP=new Float32Array(nTV*2*3),fC=new Float32Array(nTV*2*3),fI=[];tI.vertexTerrainTypes=lTTA?new Uint8Array(lTTA):(tI.vertexTerrainTypes&&tI.vertexTerrainTypes.length===nTV?tI.vertexTerrainTypes:new Uint8Array(nTV));const tCol=new THREE.Color(),sW=cC.terrainWidth/wS,sH=cC.terrainDepth/hS;for(let j=0;j<=hS;j++){for(let i=0;i<=wS;i++){const vI=j*(wS+1)+i;let x,yt,z;if(lTSP&&lTSP.length>=(vI+1)*3){x=lTSP[vI*3];yt=lTSP[vI*3+1];z=lTSP[vI*3+2];}else{x=i*sW-cC.terrainWidth/2;z=j*sH-cC.terrainDepth/2;let nV=getNoise(x,z,cC.noiseScale,cC.octaves,cC.persistence,cC.lacunarity);if(nV<cC.valleyThreshold&&Math.abs(cC.valleyThreshold)>1e-5)nV*=1+(cC.valleyThreshold-nV)*(cC.valleyDepthFactor-1)/Math.abs(cC.valleyThreshold);yt=nV*cC.terrainHeightScale;if(cC.plateauLevel>0){const hs=cC.terrainHeightScale===0?1:cC.terrainHeightScale,nH=(yt/hs+1)/2;if(nH>cC.plateauLevel)yt=THREE.MathUtils.lerp(yt,cC.plateauLevel*hs*2-hs,1-THREE.MathUtils.smoothstep(nH-cC.plateauLevel,0,cC.plateauSmoothing));}}fP[vI*3]=x;fP[vI*3+1]=yt;fP[vI*3+2]=z;const bVI=vI+nTV;fP[bVI*3]=x;fP[bVI*3+1]=yt-cC.terrainThickness;fP[bVI*3+2]=z;let tId;if(lTTA&&lTTA.length>vI)tId=tI.vertexTerrainTypes[vI];else{if(yt<cC.waterLevel+2)tId=TERRAIN_TYPES.SAND;else if(yt<cC.waterLevel+15)tId=TERRAIN_TYPES.GRASS;else if(yt<cC.terrainHeightScale*0.6)tId=TERRAIN_TYPES.ROCK;else tId=TERRAIN_TYPES.SNOW;tI.vertexTerrainTypes[vI]=tId;}tCol.set(TERRAIN_COLORS[tId]||TERRAIN_COLORS[TERRAIN_TYPES.GRASS]);fC[vI*3]=tCol.r;fC[vI*3+1]=tCol.g;fC[vI*3+2]=tCol.b;tCol.set(SIDE_BOTTOM_COLOR);fC[bVI*3]=tCol.r;fC[bVI*3+1]=tCol.g;fC[bVI*3+2]=tCol.b;}}for(let j=0;j<hS;j++){for(let i=0;i<wS;i++){const a=i+(wS+1)*j,b=i+(wS+1)*(j+1),c=(i+1)+(wS+1)*(j+1),d=(i+1)+(wS+1)*j;fI.push(a,b,d);fI.push(b,c,d);const off=nTV;fI.push(a+off,d+off,b+off);fI.push(b+off,d+off,c+off);}}for(let i=0;i<wS;i++){let v1=i,v2=i+1,v3=v1+nTV,v4=v2+nTV;fI.push(v1,v2,v3);fI.push(v2,v4,v3);v1=i+(wS+1)*hS;v2=(i+1)+(wS+1)*hS;v3=v1+nTV;v4=v2+nTV;fI.push(v1,v3,v2);fI.push(v2,v3,v4);}for(let j=0;j<hS;j++){let v1=(wS+1)*j,v2=(wS+1)*(j+1),v3=v1+nTV,v4=v2+nTV;fI.push(v1,v3,v2);fI.push(v2,v3,v4);v1=wS+(wS+1)*j;v2=wS+(wS+1)*(j+1);v3=v1+nTV,v4=v2+nTV;fI.push(v1,v2,v3);fI.push(v2,v4,v3);}const geo=new THREE.BufferGeometry();geo.setAttribute('position',new THREE.BufferAttribute(fP,3));geo.setAttribute('color',new THREE.BufferAttribute(fC,3));geo.setIndex(fI);geo.computeVertexNormals();const mat=new THREE.MeshStandardMaterial({vertexColors:true,roughness:0.8,metalness:0.2,side:THREE.DoubleSide});tI.mesh=new THREE.Mesh(geo,mat);tI.mesh.castShadow=true;tI.mesh.receiveShadow=true;tI.mesh.position.set(tI.offset.x,tI.offset.y,tI.offset.z);worldGroup.add(tI.mesh);const wg=new THREE.PlaneGeometry(cC.terrainWidth*1.5,cC.terrainDepth*1.5,1,1);wg.rotateX(-Math.PI/2);const wm=new THREE.MeshStandardMaterial({color:0x336699,transparent:true,opacity:0.7,roughness:0.1,metalness:0.3});tI.waterMesh=new THREE.Mesh(wg,wm);tI.waterMesh.position.set(tI.offset.x,cC.waterLevel+tI.offset.y,tI.offset.z);worldGroup.add(tI.waterMesh);tI.geometryData={topSurfacePositions:Array.from(fP.slice(0,nTV*3)),terrainTypes:Array.from(tI.vertexTerrainTypes.slice(0,nTV))};}
        function onTerrainMouseDown(e){if(e.button===0&&activeTerrainIndex!==-1){if(currentToolMode===TOOL_MODES.MOVE_TERRAIN){isMovingTerrainState=true;}else if(currentToolMode!==TOOL_MODES.NONE){isInteracting=true;handleTerrainInteraction(e);}}}
        function onTerrainMouseMove(e){if(isMovingTerrainState&&activeTerrainIndex!==-1){handleMoveTerrain(e);}else if(isInteracting&&activeTerrainIndex!==-1&&currentToolMode!==TOOL_MODES.NONE){handleTerrainInteraction(e);}}
        function onTerrainMouseUp(e){if(e.button===0){if(isMovingTerrainState){isMovingTerrainState=false;renderWorldTerrainList();}if(isInteracting){isInteracting=false;const aT=getActiveTerrain();if(aT&&aT.mesh&&aT.mesh.geometry&&aT.mesh.geometry.attributes.position.needsUpdate){aT.mesh.geometry.computeVertexNormals();aT.mesh.geometry.attributes.position.needsUpdate=false;}}}}
        function onTerrainDoubleClick(event){const aT=getActiveTerrain();if(!aT||!aT.mesh||!camera||!controls)return;if(currentToolMode!==TOOL_MODES.NONE&&isInteracting)return;mouse.set((event.clientX/window.innerWidth)*2-1,-(event.clientY/window.innerHeight)*2+1);raycaster.setFromCamera(mouse,camera);const ints=raycaster.intersectObject(aT.mesh);if(ints.length>0){newTargetPosition=ints[0].point.clone();isFocusTransitioning=true;}}
        function handleMoveTerrain(event){const aT=getActiveTerrain();if(!aT||!camera||!groundPlane)return;mouse.set((event.clientX/window.innerWidth)*2-1,-(event.clientY/window.innerHeight)*2+1);raycaster.setFromCamera(mouse,camera);const iPt=new THREE.Vector3();raycaster.ray.intersectPlane(groundPlane,iPt);if(iPt){aT.offset.x=Math.round(iPt.x/defaultConfig.gridCellSize)*defaultConfig.gridCellSize;aT.offset.z=Math.round(iPt.z/defaultConfig.gridCellSize)*defaultConfig.gridCellSize;if(defaultConfig.snapYToGrid)aT.offset.y=Math.round(aT.offset.y/defaultConfig.gridCellSize)*defaultConfig.gridCellSize;if(aT.mesh)aT.mesh.position.set(aT.offset.x,aT.offset.y,aT.offset.z);if(aT.waterMesh)aT.waterMesh.position.set(aT.offset.x,aT.offset.y+aT.config.waterLevel,aT.offset.z);if(aT.objectsGroup)aT.objectsGroup.position.set(aT.offset.x,aT.offset.y,aT.offset.z);renderWorldTerrainList();}}
        function handleTerrainInteraction(event){const aT=getActiveTerrain();if(!aT||!aT.mesh||!camera||currentToolMode===TOOL_MODES.NONE||!aT.mesh.geometry.attributes.position)return;mouse.set((event.clientX/window.innerWidth)*2-1,-(event.clientY/window.innerHeight)*2+1);raycaster.setFromCamera(mouse,camera);const ints=raycaster.intersectObject(aT.mesh);if(ints.length>0){const lIP=aT.mesh.worldToLocal(ints[0].point.clone()),pos=aT.mesh.geometry.attributes.position,cols=aT.mesh.geometry.attributes.color;let cC=false,pC=false;const tV=new THREE.Vector3(),nTV=(aT.config.segments+1)*(aT.config.segments+1);for(let i=0;i<nTV;i++){tV.fromBufferAttribute(pos,i);if(tV.distanceTo(lIP)<brushSize){if(currentToolMode===TOOL_MODES.PAINT){const pTCol=TERRAIN_COLORS[currentPaintType];if(aT.vertexTerrainTypes[i]!==currentPaintType){aT.vertexTerrainTypes[i]=currentPaintType;cols.setXYZ(i,pTCol.r,pTCol.g,pTCol.b);cC=true;}}else if(currentToolMode===TOOL_MODES.SCULPT_RAISE||currentToolMode===TOOL_MODES.SCULPT_LOWER){const cYt=pos.getY(i),nYt=currentToolMode===TOOL_MODES.SCULPT_RAISE?cYt+sculptStrength:cYt-sculptStrength;pos.setY(i,nYt);const bVI=i+nTV;if(bVI<pos.count)pos.setY(bVI,nYt-aT.config.terrainThickness);pC=true;}}}if(cC)cols.needsUpdate=true;if(pC)pos.needsUpdate=true;}}
        function placeObjects(tI=getActiveTerrain()){if(!tI||!tI.mesh||!tI.vertexTerrainTypes)return;if(!tI.objectsGroup){tI.objectsGroup=new THREE.Group();tI.objectsGroup.position.set(tI.offset.x,tI.offset.y,tI.offset.z);worldGroup.add(tI.objectsGroup);}while(tI.objectsGroup.children.length>0){const o=tI.objectsGroup.children[0];tI.objectsGroup.remove(o);if(o.geometry)o.geometry.dispose();if(o.material)o.material.dispose();}tI.placedObjectsData=[];const tp=tI.mesh.geometry.attributes.position;let pc={tree:0,rock_obj:0};const nTV=(tI.config.segments+1)*(tI.config.segments+1);for(let i=0;i<nTV;i++){const tt=tI.vertexTerrainTypes[i],x=tp.getX(i),ys=tp.getY(i),z=tp.getZ(i);if(tt===TERRAIN_TYPES.GRASS&&Math.random()<tI.config.treePlacementProbability){const th=2+Math.random()*3,ts=0.5+Math.random()*0.5,tg=new THREE.BoxGeometry(ts,th,ts),tm=new THREE.MeshStandardMaterial({color:0x228B22}),t=new THREE.Mesh(tg,tm);t.position.set(x,ys+th/2,z);t.castShadow=true;t.receiveShadow=true;tI.objectsGroup.add(t);tI.placedObjectsData.push({type:PLACED_OBJECT_TYPES.TREE,position:{x:t.position.x,y:t.position.y,z:t.position.z},scale:{x:ts,y:th,z:ts}});pc.tree++;}else if(tt===TERRAIN_TYPES.ROCK&&Math.random()<tI.config.rockPlacementProbability){const rr=0.5+Math.random()*1,rg=new THREE.SphereGeometry(rr,8,6),rm=new THREE.MeshStandardMaterial({color:0x696969}),r=new THREE.Mesh(rg,rm);r.position.set(x,ys+rr,z);r.castShadow=true;r.receiveShadow=true;tI.objectsGroup.add(r);tI.placedObjectsData.push({type:PLACED_OBJECT_TYPES.ROCK_OBJ,position:{x:r.position.x,y:r.position.y,z:r.position.z},scale:{radius:rr}});pc.rock_obj++;}}}
        function loadAndPlaceSavedObjects(tI,sOs){if(!tI)return;if(!tI.objectsGroup){tI.objectsGroup=new THREE.Group();tI.objectsGroup.position.set(tI.offset.x,tI.offset.y,tI.offset.z);worldGroup.add(tI.objectsGroup);}while(tI.objectsGroup.children.length>0){const o=tI.objectsGroup.children[0];tI.objectsGroup.remove(o);if(o.geometry)o.geometry.dispose();if(o.material)o.material.dispose();}tI.placedObjectsData=[];sOs.forEach(od=>{let m;if(od.type===PLACED_OBJECT_TYPES.TREE){const th=od.scale?.y||3,ts=od.scale?.x||.75,tg=new THREE.BoxGeometry(ts,th,ts),tm=new THREE.MeshStandardMaterial({color:0x228B22});m=new THREE.Mesh(tg,tm);}else if(od.type===PLACED_OBJECT_TYPES.ROCK_OBJ){const rr=od.scale?.radius||1,rg=new THREE.SphereGeometry(rr,8,6),rm=new THREE.MeshStandardMaterial({color:0x696969});m=new THREE.Mesh(rg,rm);}if(m){m.position.set(od.position.x,od.position.y,od.position.z);m.castShadow=true;m.receiveShadow=true;tI.objectsGroup.add(m);tI.placedObjectsData.push(od);}});}
        function getActiveTerrain(){return activeTerrainIndex!==-1&&worldTerrains[activeTerrainIndex]?worldTerrains[activeTerrainIndex]:null;}
        function setActiveTerrain(idx){if(idx>=0&&idx<worldTerrains.length){activeTerrainIndex=idx;updateUIForActiveTerrain();}else{activeTerrainIndex=-1;updateUIForActiveTerrain();}renderWorldTerrainList();}
        function addTerrainFromFile(event){const f=event.target.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{try{const ld=JSON.parse(e.target.result);if(!ld.config||!ld.geometry)throw new Error("Invalid file format.");const nTI=createNewTerrainInstance(`t_${Date.now()}`,ld.config,{x:0,y:0,z:0});Object.assign(nTI.config,ld.config);if(ld.config.terrainThickness===undefined)nTI.config.terrainThickness=(ld.version==="1.3"||ld.version==="1.2")?10:0;nTI.toolSettings=ld.toolSettings||{brushSize:10,sculptStrength:0.5,currentToolMode:TOOL_MODES.NONE,currentPaintType:TERRAIN_TYPES.GRASS};worldTerrains.push(nTI);const nIdx=worldTerrains.length-1;createOrUpdateTerrainInstance(nTI,ld.geometry.topSurfacePositions||ld.geometry.positions,ld.geometry.terrainTypes);if(ld.placedObjects&&Array.isArray(ld.placedObjects))loadAndPlaceSavedObjects(nTI,ld.placedObjects);else placeObjects(nTI);setActiveTerrain(nIdx);}catch(err){displayGlobalError(`Load file err: ${err.message}`,"load-file-err");}finally{event.target.value=null;}};r.onerror=(e)=>{displayGlobalError("File read err.","load-file-read-err");event.target.value=null;};r.readAsText(f);}
        function regenerateActiveTerrain(){const aT=getActiveTerrain();if(aT){showLoading();setTimeout(()=>{createOrUpdateTerrainInstance(aT,null,null);placeObjects(aT);hideLoading();},50);}else{displayGlobalError("No active terrain.","regen-no-active");}}
        function saveActiveTerrainData(){const aT=getActiveTerrain();if(!aT||!aT.geometryData){displayGlobalError("No active terrain/data.","save-active-no");return;}const sd={version:"1.3",config:JSON.parse(JSON.stringify(aT.config)),toolSettings:{currentToolMode,currentPaintType,brushSize,sculptStrength},cameraState:{position:camera.position.toArray(),target:controls?controls.target.toArray():initialCameraTarget.toArray()},geometry:aT.geometryData,placedObjects:JSON.parse(JSON.stringify(aT.placedObjectsData))};try{const j=JSON.stringify(sd),b=new Blob([j],{type:'application/json'}),u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`terrain_s_${aT.id.substring(0,5)}_${Date.now()}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}catch(e){displayGlobalError("Save active failed: "+e.message,"save-active-err");}}
        function renderWorldTerrainList(){const lE=document.getElementById('worldTerrainList');if(!lE)return;lE.innerHTML='';worldTerrains.forEach((t,idx)=>{const iD=document.createElement('div');iD.textContent=`T${idx+1}(${t.id.substring(0,5)}) `;if(idx===activeTerrainIndex)iD.classList.add('active-terrain-item');['x','y','z'].forEach(ax=>{const lbl=document.createElement('label');lbl.textContent=`${ax.toUpperCase()}:`;const inp=document.createElement('input');inp.type='number';inp.value=t.offset[ax];inp.step=defaultConfig.gridCellSize; inp.addEventListener('change',(e)=>{let newOff=parseFloat(e.target.value)||0;if(ax==='x'||ax==='z'|| (ax ==='y' && defaultConfig.snapYToGrid) ){newOff=Math.round(newOff/defaultConfig.gridCellSize)*defaultConfig.gridCellSize;}t.offset[ax]=newOff;inp.value=newOff;if(t.mesh)t.mesh.position[ax]=t.offset[ax];if(t.waterMesh)t.waterMesh.position[ax]=t.offset[ax]+(ax==='y'?t.config.waterLevel:0);if(t.objectsGroup)t.objectsGroup.position[ax]=t.offset[ax];});iD.appendChild(lbl);iD.appendChild(inp);});const sABtn=document.createElement('button');sABtn.textContent='Set Active';sABtn.classList.add('world-terrain-button');sABtn.onclick=()=>setActiveTerrain(idx);iD.appendChild(sABtn);const rmBtn=document.createElement('button');rmBtn.textContent='Remove';rmBtn.classList.add('world-terrain-button');rmBtn.style.backgroundColor='#f44336';rmBtn.onclick=()=>removeTerrainFromWorld(idx);iD.appendChild(rmBtn);lE.appendChild(iD);});}
        function removeTerrainFromWorld(idx){if(idx<0||idx>=worldTerrains.length)return;const rT=worldTerrains.splice(idx,1)[0];if(rT){if(rT.mesh)worldGroup.remove(rT.mesh);if(rT.waterMesh)worldGroup.remove(rT.waterMesh);if(rT.objectsGroup)worldGroup.remove(rT.objectsGroup);}if(activeTerrainIndex===idx)setActiveTerrain(-1);else if(activeTerrainIndex>idx)activeTerrainIndex--;renderWorldTerrainList();}
        function saveWorldData(){const wDTS=worldTerrains.map(t=>({id:t.id,config:t.config,toolSettings:t.toolSettings||{brushSize,sculptStrength,currentToolMode,currentPaintType},geometryData:t.geometryData,placedObjectsData:t.placedObjectsData,offset:t.offset}));const sd={version:"world-1.2",gridConfig:{gridCellSize:defaultConfig.gridCellSize,gridDisplaySize:defaultConfig.gridDisplaySize,showGrid:defaultConfig.showGrid,snapYToGrid:defaultConfig.snapYToGrid},worldTerrains:wDTS,cameraState:{position:camera.position.toArray(),target:controls?controls.target.toArray():initialCameraTarget.toArray()},activeTerrainIndex:activeTerrainIndex};try{const j=JSON.stringify(sd),b=new Blob([j],{type:'application/json'}),u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`world_grid_${Date.now()}.world.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}catch(e){displayGlobalError("Save world failed: "+e.message,"save-world-err");}}
        function loadWorldData(event){const f=event.target.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{try{const lW=JSON.parse(e.target.result);if(!lW.worldTerrains||!Array.isArray(lW.worldTerrains))throw new Error("Invalid world file.");worldTerrains.forEach(t=>{if(t.mesh)worldGroup.remove(t.mesh);if(t.waterMesh)worldGroup.remove(t.waterMesh);if(t.objectsGroup)worldGroup.remove(t.objectsGroup);});worldTerrains=[];activeTerrainIndex=-1;showLoading();if(lW.gridConfig){defaultConfig.gridCellSize=lW.gridConfig.gridCellSize??defaultConfig.gridCellSize;defaultConfig.gridDisplaySize=lW.gridConfig.gridDisplaySize??defaultConfig.gridDisplaySize;defaultConfig.showGrid=lW.gridConfig.showGrid??defaultConfig.showGrid;defaultConfig.snapYToGrid=lW.gridConfig.snapYToGrid??false;}else{defaultConfig.snapYToGrid=false;}updateGridHelper();updateUIForActiveTerrain();lW.worldTerrains.forEach((tD,idx)=>{const nTI=createNewTerrainInstance(tD.id||`lt_${idx}_${Date.now()}`,tD.config||defaultConfig,tD.offset||{x:0,y:0,z:0});nTI.toolSettings=tD.toolSettings||{brushSize:10,sculptStrength:0.5,currentToolMode:TOOL_MODES.NONE,currentPaintType:TERRAIN_TYPES.GRASS};if(tD.config&&tD.config.terrainThickness===undefined)nTI.config.terrainThickness=(tD.config.version==="1.3"||tD.config.version==="1.2")?10:0;worldTerrains.push(nTI);createOrUpdateTerrainInstance(nTI,tD.geometryData.topSurfacePositions,tD.geometryData.terrainTypes);loadAndPlaceSavedObjects(nTI,tD.placedObjectsData||[]);});if(lW.cameraState&&camera&&controls){camera.position.fromArray(lW.cameraState.position);controls.target.fromArray(lW.cameraState.target);controls.update();}else{resetCamera();}setActiveTerrain(lW.activeTerrainIndex!==undefined?lW.activeTerrainIndex:(worldTerrains.length>0?0:-1));hideLoading();}catch(err){displayGlobalError(`Load world err: ${err.message}`,"load-world-err");hideLoading();}finally{event.target.value=null;}};r.onerror=(e)=>{displayGlobalError("File read err.","load-world-file-err");event.target.value=null;};r.readAsText(f);}
        
        async function handleGenerateLoreClick(customBasePrompt = null) { /* Minified */ const aT=getActiveTerrain();if(!aT){displayGlobalError("Select terrain for lore.","lore-no-active");return;}showLoading(true);loreTextElement.textContent="Generating lore...";loreModal.style.display="block";let p;if(customBasePrompt){p=customBasePrompt;p+=` Terrain approx ${aT.config.terrainWidth}x${aT.config.terrainDepth}, max height ${aT.config.terrainHeightScale}, thickness ${aT.config.terrainThickness}.`;}else{p=`Generate lore (2-4 sentences) for a 3D terrain: Dimensions ${aT.config.terrainWidth}x${aT.config.terrainDepth}, height ${aT.config.terrainHeightScale}. Shape: `;if(aT.config.terrainHeightScale>20)p+="mountains/valleys. ";else if(aT.config.terrainHeightScale>5)p+="rolling hills. ";else p+="flat plains. ";if(aT.config.waterLevel>-10)p+="Has water. ";else p+="Mostly dry. ";const tC={};let dTS="various";if(aT.vertexTerrainTypes&&aT.vertexTerrainTypes.length>0){aT.vertexTerrainTypes.forEach(tId=>{const tN=Object.keys(TERRAIN_TYPES).find(k=>TERRAIN_TYPES[k]===tId);if(tN)tC[tN]=(tC[tN]||0)+1;});const sT=Object.entries(tC).sort(([,a],[,b])=>b-a);if(sT.length>0)dTS=sT.slice(0,2).map(e=>e[0].toLowerCase()).join(" & ");}p+=`Dominant types: ${dTS}. Thickness: ${aT.config.terrainThickness}. What secrets might it hold?`;}try{let cH=[{role:"user",parts:[{text:p}]}];const pL={contents:cH},apiK="";const apiU=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiK}`;const rsp=await fetch(apiU,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(pL)});if(!rsp.ok){const eB=await rsp.text();throw new Error(`API fail ${rsp.status}: ${eB}`);}const res=await rsp.json();if(res.candidates&&res.candidates.length>0&&res.candidates[0].content&&res.candidates[0].content.parts&&res.candidates[0].content.parts.length>0){loreTextElement.textContent=res.candidates[0].content.parts[0].text;}else{throw new Error("No content in API response.");}}catch(err){loreTextElement.textContent="Lore gen failed: "+err.message;displayGlobalError("Gemini API err: "+err.message,"gemini-api-err");}finally{hideLoading(true);}}

        function animate(){requestAnimationFrame(animate);if(animationFrameCount++===0&&renderer)console.log("LOG: animate() first frame.");if(isFocusTransitioning&&newTargetPosition&&controls){controls.target.lerp(newTargetPosition,focusSmoothingFactor);if(controls.target.distanceTo(newTargetPosition)<0.01){controls.target.copy(newTargetPosition);isFocusTransitioning=false;newTargetPosition=null;}}if(controls)controls.update();if(renderer&&scene&&camera)renderer.render(scene,camera);}
        function onWindowResize(){if(camera&&renderer){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);}}
        
        window.onload = () => { console.log("Diag: window.onload. Starting init()."); init(); };
    </script>
</body>
</html>
