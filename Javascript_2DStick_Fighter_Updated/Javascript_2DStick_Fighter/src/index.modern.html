<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stick Fighter Modular UI (Modern)</title>
  <link rel="stylesheet" href="./styles/main.css">
</head>
<body>
  <div id="gameContainer" class="mt-2">
    <div id="healthBars" class="health-bar-container w-full max-w-3xl px-2" style="display: none;"></div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div id="messageDisplay"></div>
    <div id="pauseMenuTitle" class="menu-overlay-text" style="display:none;">Paused</div>
    <div id="settingsMenuTitle" class="menu-overlay-text" style="display:none;">Settings</div>
  </div>
  <button id="resetButton" class="mt-4">Main Menu</button>
  <!-- Add Start Game button and wire to trigger the game loop -->
  <button id="startGameBtn" class="mt-2">Start Game</button>
  <div class="controls-info w-full max-w-xl mt-4 p-4 bg-gray-200 rounded-lg shadow"></div>
  <script type="module" src="./index.js"></script>
  <script>
    // --- Advanced Integration: Global Event Bus and UI Sync ---
    (async function() {
      // Load and expose eventManager & gameContext first
      const [{ eventManager }, gc] = await Promise.all([
        import('./game/eventManager.js'),
        import('./game/gameContext.js')
      ]);
      window.eventManager = eventManager;
      window.gameContext = gc.default || gc.gameContext;
      // Expose context utilities globally for console debugging
      window.setMenuState = gc.setMenuState;
      window.registerSystem = gc.registerSystem;
      window.broadcastGameEvent = gc.broadcastGameEvent;
      window.logDiagnostic = gc.logDiagnostic;
      if (window.stickFighterDebug) {
        window.stickFighterDebug.eventManager = eventManager;
        window.stickFighterDebug.gameContext = window.gameContext;
      }
      // Subscriptions now safe to call
      eventManager.subscribe('pause', () => {
        window.menuUI?.updateMenuState('PAUSED');
      });
      eventManager.subscribe('resume', () => {
        window.menuUI?.hideMenu();
      });
      eventManager.subscribe('gameOver', () => {
        window.menuUI?.updateMenuState('END');
      });
      eventManager.subscribe('showMenu', ({ state }) => {
        window.menuUI?.updateMenuState(state);
      });
      // Expose other modules
      import('./game/stickman.js').then(m => window.stickman = m);
      import('./game/controls.js').then(m => window.controls = m);
      import('./game/ai.js').then(m => window.ai = m);
      import('./game/obstacles.js').then(m => window.obstacles = m);
      import('./game/powerups.js').then(m => {
        window.powerups = m;
        window.spawnRandomPowerUp = m.spawnRandomPowerUp;
        window.clearPowerUps = m.clearPowerUps;
        window.updateAllPowerUps = m.updateAllPowerUps;
        window.powerUpDiagnostics = m.powerUpDiagnostics;
      });
    })();
    // Debug: Show a message if the app is ready
    window.addEventListener('stickFighterAppReady', () => {
      if (window.messageDisplayUI && window.messageDisplayUI.showMessage) {
        window.messageDisplayUI.showMessage('Stick Fighter UI Ready!', { duration: 1200 });
      }
    });
    // Debug: Show a message if a global error occurs
    window.addEventListener('error', (e) => {
      if (window.messageDisplayUI && window.messageDisplayUI.showMessage) {
        window.messageDisplayUI.showMessage('A global error occurred. See console for details.', { critical: true, duration: 0 });
      }
    });
    window.addEventListener('unhandledrejection', (e) => {
      if (window.messageDisplayUI && window.messageDisplayUI.showMessage) {
        window.messageDisplayUI.showMessage('A promise error occurred. See console for details.', { critical: true, duration: 0 });
      }
    });
    // --- Advanced: Integrate controls, obstacles, and menu for dynamic UI/gameplay ---
    import('./game/controls.js').then(controlsMod => {
      if (window.menuUI && window.menuUI.onMenuEvent) {
        // Example: When menu state changes, update controls or obstacles as needed
        window.menuUI.onMenuEvent('showMenu', ({ state }) => {
          if (state === 'SETTINGS_MENU' && controlsMod.enableRemapUI) {
            controlsMod.enableRemapUI(); // Hypothetical: show remap UI
          }
          if (state === 'MENU' && controlsMod.resetToDefaults) {
            controlsMod.resetToDefaults();
          }
        });
      }
      // Example: Listen for control changes and update obstacles if needed
      if (controlsMod.onControlsChanged && window.obstacles) {
        controlsMod.onControlsChanged(newBindings => {
          if (window.obstacles.updateForControls) {
            window.obstacles.updateForControls(newBindings);
          }
        });
      }
    });
    import('./game/obstacles.js').then(obstaclesMod => {
      // Example: When menu triggers a new game, reset obstacles
      if (window.menuUI && window.menuUI.onMenuEvent) {
        window.menuUI.onMenuEvent('menuStart', () => {
          if (obstaclesMod.resetObstacles) obstaclesMod.resetObstacles();
        });
      }
      // Expose obstacles for runtime inspection
      window.obstacles = obstaclesMod;
    });
    // Example: When menu triggers a mode select, update controls/obstacles
    if (window.menuUI && window.menuUI.onMenuEvent) {
      window.menuUI.onMenuEvent('menuModeSelect', () => {
        if (window.controls && window.controls.setMode) window.controls.setMode('modeSelect');
        if (window.obstacles && window.obstacles.prepareForMode) window.obstacles.prepareForMode('modeSelect');
      });
    }
    // Wire our static Start Game button to begin the game loop
    document.getElementById('startGameBtn')?.addEventListener('click', () => {
      window.eventManager?.dispatchEvent('menuStart');
    });
  </script>
</body>
</html>
