const t=[{key:"stickmanSprite",type:"image",path:"./assets/sprites/stickman.png"},{key:"background",type:"image",path:"./assets/backgrounds/arena.png"},{key:"hitSound",type:"audio",path:"./assets/sfx/hit.wav"}];const e="stickFighterSave";function i(t){try{const i=JSON.stringify(t);localStorage.setItem(e,i)}catch(t){console.error("Error saving game state:",t)}}function s(){const t=localStorage.getItem(e);if(!t)return null;try{const e=JSON.parse(t);if(!e.players||!Array.isArray(e.players))throw new Error("Invalid save format");return e}catch(t){return console.warn("Corrupt save detected—clearing:",t),localStorage.removeItem(e),null}}const r=new class{constructor(){this.listeners={},this.eventLog=[],this.debugMode=!1}subscribe(t,e){"function"==typeof e?(this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),this.debugMode&&this._log(`Subscribed to event: ${t}`)):this._logError("subscribe: callback must be a function",{eventType:t,callback:e})}unsubscribe(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter((t=>t!==e)),this.debugMode&&this._log(`Unsubscribed from event: ${t}`))}dispatchEvent(t,e){this.listeners[t]&&(this.eventLog.push({eventType:t,detail:e,timestamp:Date.now()}),this.listeners[t].forEach((i=>{try{i(e)}catch(i){this._logError(`Error in event listener for ${t}: ${i.message}`,{eventType:t,detail:e,error:i})}})),this.debugMode&&this._log(`Dispatched event: ${t}`,e))}once(t,e){const i=s=>{this.unsubscribe(t,i),e(s)};this.subscribe(t,i)}getEventLog(){return[...this.eventLog]}clearEventLog(){this.eventLog=[]}enableDebug(){this.debugMode=!0}disableDebug(){this.debugMode=!1}_log(t,e){void 0!==e?console.log(`[EventManager] ${t}`,e):console.log(`[EventManager] ${t}`)}_logError(t,e){void 0!==e?console.error(`[EventManager ERROR] ${t}`,e):console.error(`[EventManager ERROR] ${t}`)}},n={players:[],aiControllers:[],obstacles:[],powerups:[],hitSparks:[],eventManager:r,diagnostics:{},menuState:null};function o(t,e){n[t]=e,r?.dispatchEvent("systemRegistered",{name:t,ref:e})}function a(t,e){n.diagnostics[t]||(n.diagnostics[t]=[]),n.diagnostics[t].push(e),r?.dispatchEvent("diagnostic",{event:t,data:e})}const h={MENU:"MENU",SETTINGS:"SETTINGS_MENU",PAUSED:"PAUSED",PLAYING:"PLAYING",END:"END"};let l=h.MENU;const c=[];function d(){return l}function u(t){Object.values(h).includes(t)&&(l=t,n&&(n.menuState=t),c.forEach((e=>e(t))),r?.dispatchEvent("screenStateChanged",{state:t}),r&&[h.MENU,h.PAUSED,h.SETTINGS,h.END].includes(t)&&r.dispatchEvent("showMenu",{state:t}))}function p(t){"function"==typeof t&&c.push(t)}function g(){const t=document.getElementById("pauseMenuTitle"),e=document.getElementById("settingsMenuTitle"),i=document.getElementById("gameCanvas");t&&(t.style.display=l===h.PAUSED?"block":"none"),e&&(e.style.display=l===h.SETTINGS?"block":"none"),i&&(l===h.PLAYING||l===h.PAUSED?i.style.display="block":i.style.display="none")}p(g),r&&(r.subscribe("pause",(()=>u(h.PAUSED))),r.subscribe("resume",(()=>u(h.PLAYING))),r.subscribe("showMenu",(({state:t})=>u(t||h.MENU))),r.subscribe("gameOver",(()=>u(h.END))),r.subscribe("fightStart",(()=>u(h.PLAYING))));class f{constructor(t,e,i,s,r="#8D6E63",n={}){try{if("number"!=typeof t||"number"!=typeof e||"number"!=typeof i||"number"!=typeof s)throw new TypeError("Obstacle: x, y, width, and height must be numbers");this.x=t,this.y=e,this.width=i,this.height=s,this.color=r,this.type=n.type||"static",this.options=n,this.id=n.id||`obstacle_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,this.debug=n.debug||!1,this.retryCount=0,this.maxRetries=n.maxRetries||2}catch(t){this.handleError(t,"constructor")}}draw(t){let e=0;for(;e<=this.maxRetries;)try{if(!t)throw new Error("Obstacle.draw: ctx is required");t.save(),t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height),t.strokeStyle="#5D4037",t.lineWidth=2,t.strokeRect(this.x,this.y,this.width,this.height),this.debug&&(t.strokeStyle="red",t.setLineDash([4,2]),t.strokeRect(this.x,this.y,this.width,this.height),t.setLineDash([])),t.restore();break}catch(t){if(this.handleError(t,"draw"),e++,e>this.maxRetries)break}}getAABB(){return{x:this.x,y:this.y,width:this.width,height:this.height}}containsPoint(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}overlaps(t){return A(this.getAABB(),t)}setColor(t){try{if("string"!=typeof t)throw new TypeError("Obstacle.setColor: color must be a string");this.color=t}catch(t){this.handleError(t,"setColor")}}move(t,e){try{if("number"!=typeof t||"number"!=typeof e)throw new TypeError("Obstacle.move: dx and dy must be numbers");this.x+=t,this.y+=e}catch(t){this.handleError(t,"move")}}clone(){return new f(this.x,this.y,this.width,this.height,this.color,{...this.options,id:void 0})}toString(){return`Obstacle(${this.x},${this.y},${this.width},${this.height},${this.color},id=${this.id})`}describe(){return{id:this.id,type:this.type,x:this.x,y:this.y,width:this.width,height:this.height,color:this.color,options:{...this.options},area:this.width*this.height,aspectRatio:this.width/(this.height||1),isWide:this.width>this.height,isTall:this.height>this.width,isSquare:Math.abs(this.width-this.height)<2,top:this.y,bottom:this.y+this.height,left:this.x,right:this.x+this.width,center:{x:this.x+this.width/2,y:this.y+this.height/2},debug:this.debug,canClimb:!!this.options.canClimb,canDestroy:!!this.options.canDestroy,canJumpOver:!!this.options.canJumpOver}}handleError(t,e){this.errorLog||(this.errorLog=[]);const i=`[Obstacle:${this.id}] Error in ${e}: ${t.message}`;this.errorLog.push({time:Date.now(),method:e,error:t}),this.debug&&(r?.dispatchEvent("obstacleError",{obstacle:this,method:e,error:t}),console.error(i,t))}}const y=[];const m=[];function b(t){"function"==typeof t&&m.push(t)}function w(){try{y.length=0,r.dispatchEvent("obstaclesCleared")}catch(t){r?.dispatchEvent("obstacleError",{method:"clearObstacles",error:t}),console.error(`[Obstacle] Error in clearObstacles: ${t.message}`,t)}}function v(t){for(const e of y)if(A(t,e.getAABB()))return e;return null}function A(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}function E(t){for(const e of y)e.draw(t)}function x(t){try{w();for(const e of t)y.push(e);r.dispatchEvent("obstaclesSet",{obstacles:y})}catch(t){r?.dispatchEvent("obstacleError",{method:"setObstacles",error:t}),console.error(`[Obstacle] Error in setObstacles: ${t.message}`,t)}}function S(t,e){if(d&&"PLAYING"!==d())return;const i=e?.ctx||("undefined"!=typeof document?document.getElementById("gameCanvas")?.getContext("2d"):null);i&&E(i)}r?.subscribe?.("obstacleAdded",(({obstacle:t})=>{t.debug&&console.log("[Obstacle] Added:",t.toString())})),r?.subscribe?.("obstacleRemoved",(({obstacle:t})=>{t?.debug&&console.log("[Obstacle] Removed:",t?.toString?.())})),r?.subscribe?.("obstaclesCleared",(()=>{console.log("[Obstacle] All obstacles cleared")})),r?.subscribe?.("obstaclesSet",(({obstacles:t})=>{console.log(`[Obstacle] Obstacles set (${t.length})`)})),r?.subscribe?.("obstacleError",(({obstacle:t,method:e,error:i})=>{console.error(`[Obstacle] Error in ${e}:`,i,t)}));var k={Obstacle:f,obstacles:y,addObstacle:function(t){let e=0;for(;e<=(t?.maxRetries||2);)try{if(!(t instanceof f))throw new TypeError("addObstacle: argument must be an Obstacle");y.push(t),r.dispatchEvent("obstacleAdded",{obstacle:t});break}catch(i){if(t?.handleError?.(i,"addObstacle"),e++,e>(t?.maxRetries||2))break}},onObstacleDestroyed:b,removeObstacleById:function(t){let e=0;for(;e<=2;)try{const e=y.findIndex((e=>e.id===t));if(-1!==e){const[t]=y.splice(e,1);r.dispatchEvent("obstacleRemoved",{obstacle:t});for(const e of m)try{e(t)}catch(t){console.warn("[obstacles] ObstacleDestroyed listener error:",t)}return t}return null}catch(t){if(e++,r?.dispatchEvent("obstacleError",{method:"removeObstacleById",error:t}),console.error(`[Obstacle] Error in removeObstacleById: ${t.message}`,t),e>2)break}return null},clearObstacles:w,checkObstacleCollision:v,rectsOverlap:A,drawAllObstacles:E,getObstacleAtPoint:function(t,e){return y.find((i=>i.containsPoint(t,e)))||null},getObstaclesInRect:function(t){return y.filter((e=>e.overlaps(t)))},getObstacleById:function(t){return y.find((e=>e.id===t))||null},setObstacles:x,setObstaclesDebug:function(t){for(const e of y)e.debug=t},serializeObstacles:function(){return y.map((t=>({x:t.x,y:t.y,width:t.width,height:t.height,color:t.color,type:t.type,id:t.id})))},loadObstaclesFromArray:function(t){x(t.map((t=>new f(t.x,t.y,t.width,t.height,t.color,{type:t.type,id:t.id}))))},describeAllObstacles:function(){return y.map((t=>t.describe()))},updateAllObstacles:S};const P={},T=[];let C={};const M=Object.freeze({player1:Object.freeze({left:"KeyA",right:"KeyD",jump:"KeyW",punch:"KeyF",kick:"KeyG",guard:"ShiftLeft",slam:"KeyS",airDodge:"KeyC",parry:"KeyV",run:"KeyQ",turn:"KeyR"}),player2:Object.freeze({left:"ArrowLeft",right:"ArrowRight",jump:"ArrowUp",punch:"KeyK",kick:"KeyL",guard:"ShiftRight",slam:"ArrowDown",airDodge:"KeyM",parry:"KeyN",run:"KeyU",turn:"KeyP"})});function I(){return{player1:{...C.player1},player2:{...C.player2}}}let L={onInput:null,onRemap:null,onRecording:null,onPlayback:null};function D(t,e){if(L&&"function"==typeof L.onInput)try{L.onInput(t,e)}catch(t){}r.dispatchEvent("controlsDebug",{eventType:t,payload:e})}let O={active:!1,sequence:[],lastInputTime:0,comboWindow:350,minComboLength:2,maxComboLength:6,onCombo:null};function R(){O.active=!1,O.sequence=[],O.lastInputTime=0}function _(t,e,i){if(!e)return;const s=i??Date.now();!function(t){O.sequence.length>0&&t-O.lastInputTime>O.comboWindow&&R()}(s),O.active||(O.active=!0),O.sequence.push({code:t,isDown:e,timestamp:s}),O.lastInputTime=s,O.sequence.length>O.maxComboLength&&O.sequence.shift(),O.sequence.length>=O.minComboLength&&(D("combo",{sequence:[...O.sequence]}),function(t,e){const i={player:t,comboSequence:e,timestamp:Date.now()};for(const t of U)try{t(i)}catch(t){"undefined"!=typeof window&&window.DEBUG_MODE&&console.warn("[controls] ComboPerformed listener error:",t)}"function"==typeof r?.dispatchEvent&&r.dispatchEvent("comboPerformed",i)}("player1",[...O.sequence]),R())}const U=[];function K(t){"function"==typeof t&&U.push(t)}function N(t,e){try{if(function(t,e){return!(!e||!t.repeat)}(t,e))return;P[t.code]=e,r.dispatchEvent("input",{code:t.code,isDown:e,event:t}),function(t,e){D("input",{code:t.code,isDown:e,event:t})}(t,e),function(t,e){T.forEach((i=>{try{i(t.code,e,t)}catch(e){t.code}}))}(t,e),function(t,e){_(t.code,e,Date.now())}(t,e)}catch(e){t.code}}function H(t){d&&"PLAYING"!==d()||N(t,!0)}function B(t){d&&"PLAYING"!==d()||N(t,!1)}function Z(){C={player1:{...M.player1},player2:{...M.player2}},r.dispatchEvent("keyBindingsChanged",{bindings:I()})}var F;function G(t){"function"==typeof t&&r.subscribe("keyBindingsChanged",(({bindings:e})=>t(e)))}function W(){"undefined"==typeof window||window._stickfighterControlsAttached||(window.addEventListener("keydown",H),window.addEventListener("keyup",B),window._stickfighterControlsAttached=!0)}"undefined"==typeof window||window._stickfighterControlsAttached||(window.addEventListener("keydown",H),window.addEventListener("keyup",B),window._stickfighterControlsAttached=!0),r&&"function"==typeof r.subscribe&&(r.subscribe("menuMainMenu",(()=>{Z()})),r.subscribe("resetKeyBindings",(()=>{Z()}))),F=M,C={player1:{...M.player1,...F?.player1||{}},player2:{...M.player2,...F?.player2||{}}};class ${constructor(t,e){this.propertyPath=t,this.keyframes=e}}class j{constructor(t,e,i,s=!1){this.name=t,this.duration=e,this.tracks=i,this.loop=s}}class z{constructor(){this.currentClip=null,this.time=0,this.playing=!1,this.onFinish=null,this.blendActive=!1,this.blendElapsed=0,this.blendDuration=0,this.initialPose={},this.latestPose={}}play(t,e={}){e.blend&&(this.blendActive=!0,this.blendElapsed=0,this.blendDuration=e.blend,this.initialPose={...this.latestPose}),this.currentClip=t,this.time=0,this.playing=!0,this.currentClip.loop=e.loop??t.loop,this.onFinish=e.onFinish||null}stop(){this.playing=!1}samplePose(t,e){const i={};for(const s of t.tracks){const t=s.keyframes;if(!t.length)continue;let r=t.findIndex((t=>t.time>=e));if(-1===r)i[s.propertyPath]=t[t.length-1].value;else if(0===r)i[s.propertyPath]=t[0].value;else{const n=t[r-1],o=t[r],a=(e-n.time)/(o.time-n.time);i[s.propertyPath]=n.value+(o.value-n.value)*a}}return i}update(t){if(!this.playing||!this.currentClip)return{};this.time+=t,this.time>this.currentClip.duration&&(this.currentClip.loop?this.time%=this.currentClip.duration:(this.time=this.currentClip.duration,this.playing=!1,this.onFinish?.()));const e={};for(const t of this.currentClip.tracks){const i=t.keyframes;if(!i.length)continue;let s=i.findIndex((t=>t.time>=this.time));if(-1===s)e[t.propertyPath]=i[i.length-1].value;else if(0===s)e[t.propertyPath]=i[0].value;else{const r=i[s-1],n=i[s],o=(this.time-r.time)/(n.time-r.time);e[t.propertyPath]=r.value+(n.value-r.value)*o}}const i=this.blendPose(e,t);return this.latestPose=i,i}blendPose(t,e){if(!this.blendActive)return t;this.blendElapsed+=e;const i=Math.min(this.blendElapsed/this.blendDuration,1),s={};for(const e in t){const r=void 0!==this.initialPose[e]?this.initialPose[e]:t[e];s[e]=r*(1-i)+t[e]*i}return 1===i&&(this.blendActive=!1),s}}const Y=new j("idle",1e3,[new $("leftShoulderZ",[{time:0,value:-.2},{time:500,value:.2},{time:1e3,value:-.2}]),new $("rightShoulderZ",[{time:0,value:.2},{time:500,value:-.2},{time:1e3,value:.2}])],!0);function X(t,e,i,s,r){Math.atan2(i.y-e.y,i.x-e.x),t.save(),t.lineWidth=s,t.lineCap="round",t.strokeStyle=r,t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),t.stroke(),t.restore()}new j("walk",600,[new $("leftHipZ",[{time:0,value:-.4},{time:300,value:.4},{time:600,value:-.4}]),new $("rightHipZ",[{time:0,value:.4},{time:300,value:-.4},{time:600,value:.4}]),new $("leftShoulderZ",[{time:0,value:.5},{time:300,value:-.5},{time:600,value:.5}]),new $("rightShoulderZ",[{time:0,value:-.5},{time:300,value:.5},{time:600,value:-.5}]),new $("leftKneeZ",[{time:0,value:.2},{time:300,value:-.2},{time:600,value:.2}]),new $("rightKneeZ",[{time:0,value:-.2},{time:300,value:.2},{time:600,value:-.2}])],!0);const J=Object.create(null),q={};function V(t,e){if(!t||"object"!=typeof e)throw new Error("registerHitSparkType: Invalid arguments");if(J[t]={...e},e.spriteSheet&&"undefined"!=typeof window&&!q[t]){const i=new window.Image;i.src=e.spriteSheet,q[t]=i}r?.dispatchEvent("hitSparkTypeRegistered",{type:t,config:e})}V("default",{color:"#fff",particleCount:8,duration:300,size:8,sound:null}),V("heavy",{color:"#ff0",particleCount:16,duration:500,size:12,sound:null}),V("critical",{color:"#f00",particleCount:24,duration:700,size:16,sound:null});class Q{constructor(t,e,i="default",s={}){this.x=t,this.y=e,this.type=i;const n=J[i]||{};this.color=s.color||n.color||"#fff",this.particleCount=s.particleCount||n.particleCount||8,this.duration=s.duration||n.duration||300,this.size=s.size||n.size||8,this.sound=s.sound||n.sound||null,this.spawnTime=Date.now(),this.active=!0,this.id=s.id||`hitspark_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,this.debug=s.debug||!1,this.meta={...n.meta||{},...s.meta||{}},this.impact=s.impact||{},this.comboCount=s.comboCount||1,this.spriteSheet=s.spriteSheet||n.spriteSheet||null,this.frames=s.frames||n.frames||null,this.animSpeed=s.animSpeed||n.animSpeed||1,this.frameIndex=0,this.frameElapsed=0,this.style=s.style||n.style||null,this.move=s.move||n.move||null,this.character=s.character||n.character||null,this.particles=this._createParticles(),this.sound&&this.playSound(),r?.dispatchEvent("hitSparkSpawned",{hitSpark:this})}_createParticles(){const t=[],e=this.impact||{};let i="number"==typeof e.angle?e.angle:null,s="number"==typeof e.force?e.force:1,r="number"==typeof e.vx?e.vx:null,n="number"==typeof e.vy?e.vy:null;for(let e=0;e<this.particleCount;e++){let o=null!==i?i+(Math.random()-.5)*Math.PI/3:2*Math.PI*e/this.particleCount,a=s+.5*Math.random(),h=null!==r?r+(Math.random()-.5):Math.cos(o)*a,l=null!==n?n+(Math.random()-.5):Math.sin(o)*a;t.push({x:this.x,y:this.y,vx:h,vy:l,alpha:1,size:this.size*(.7+.6*Math.random())})}return t}update(t){if(!this.active)return;if(Date.now()-this.spawnTime>this.duration)return this.active=!1,void r?.dispatchEvent("hitSparkExpired",{hitSpark:this});this.frames&&this.frames.length>0&&(this.frameElapsed+=t*this.animSpeed,this.frameElapsed>1e3/60&&(this.frameIndex=(this.frameIndex+1)%this.frames.length,this.frameElapsed=0));for(const e of this.particles)e.x+=e.vx*(t/(1e3/60)),e.y+=e.vy*(t/(1e3/60)),e.alpha-=t/(1e3/60)*.03,e.alpha<0&&(e.alpha=0)}draw(t){if(this.active&&t){if(t.save(),this.spriteSheet&&q[this.type])for(const e of this.particles){t.globalAlpha=e.alpha;const i=q[this.type],s=i.width/(this.frames?.length||1),r=i.height,n=this.frames?this.frames[this.frameIndex]:0;t.drawImage(i,n*s,0,s,r,e.x-s/2,e.y-r/2,s,r)}else for(const e of this.particles)t.globalAlpha=e.alpha,t.fillStyle=this.color,t.beginPath(),t.arc(e.x,e.y,e.size,0,2*Math.PI),t.fill();t.restore()}}playSound(){if("function"==typeof this.sound)this.sound();else if("undefined"!=typeof window&&this.sound){new window.Audio(this.sound).play()}}serialize(){return{id:this.id,x:this.x,y:this.y,type:this.type,color:this.color,particleCount:this.particleCount,duration:this.duration,size:this.size,sound:this.sound,spawnTime:this.spawnTime,active:this.active,debug:this.debug,meta:{...this.meta}}}static deserialize(t){return new Q(t.x,t.y,t.type,t)}describe(){return this.serialize()}}const tt=[];function et(t,e,i="default",s={}){const n=s.impact||{};let o=i;s.style&&J[s.style]&&(o=s.style),s.move&&J[s.move]&&(o=s.move),s.character&&J[s.character]&&(o=s.character);const a=function(){const t=Date.now();t-it<rt?st++:st=1;return it=t,st}(),h=J[o]||J[i]||{};if((h.screenShake||s.screenShake)&&r?.dispatchEvent("hitSparkCameraEffect",{effect:"shake",strength:h.screenShake||s.screenShake,combo:a}),(h.flash||s.flash)&&r?.dispatchEvent("hitSparkCameraEffect",{effect:"flash",color:h.flash||s.flash}),(h.slowMo||s.slowMo)&&r?.dispatchEvent("hitSparkCameraEffect",{effect:"slowMo",duration:h.slowMo||s.slowMo}),h.soundLayer&&a>1)if("function"==typeof h.soundLayer)h.soundLayer(a);else if("undefined"!=typeof window&&h.soundLayer){const t=new window.Audio(h.soundLayer);t.volume=Math.min(1,.5+.1*a),t.play()}const l=new Q(t,e,o,{...s,impact:n,comboCount:a});return tt.push(l),l}let it=0,st=0;const rt=250;function nt(t,e){for(const i of tt)i.update(t,e);for(let t=tt.length-1;t>=0;t--)tt[t].active||tt.splice(t,1)}function ot(t){for(const e of tt)try{e.draw(t)}catch(t){console.error("[hitSparks] Error drawing hit spark:",t)}}b(((t,{hitter:e,impact:i}={})=>{let s=null,r=1;i&&"number"==typeof i.angle?s=i.angle:e&&"number"==typeof e.vx&&"number"==typeof e.vy&&(s=Math.atan2(e.vy,e.vx),r=Math.sqrt(e.vx*e.vx+e.vy*e.vy)),et(t.x,t.y,"heavy",{impact:{angle:s,force:r},style:t.type||void 0,screenShake:8,debug:!0})})),r?.subscribe&&r.subscribe("powerupCollected",(({powerup:t,player:e})=>{et(e.x,e.y,"default",{color:t.color,style:t.type,impact:{angle:-Math.PI/2,force:1.5},flash:t.color,debug:!0})})),dt?.prototype&&(dt.prototype.spawnHitSparkOnHit=function(t,e,i={}){et(t.x,t.y,e||"default",{impact:{angle:i.angle,force:i.force},style:e,character:this.characterName,screenShake:i.critical?12:0,slowMo:i.critical?200:0,debug:!0})}),K(((t,e,i={})=>{et(e.x,e.y,i.move||"critical",{impact:{angle:i.angle,force:i.force},style:t,soundLayer:i.soundLayer,screenShake:10+2*(i.level||0),flash:"#fff",slowMo:150,debug:!0})})),r?.subscribe&&r.subscribe("hitSparkCameraEffect",(({effect:t,strength:e,color:i,duration:s,combo:r})=>{"shake"===t&&"undefined"!=typeof window&&window.cameraShake&&window.cameraShake(e||8,r),"flash"===t&&"undefined"!=typeof window&&window.screenFlash&&window.screenFlash(i||"#fff"),"slowMo"===t&&"undefined"!=typeof window&&window.slowMo&&window.slowMo(s||100)})),r?.subscribe&&r.subscribe("playerHit",(({defender:t,impact:e})=>{const i=e?.x??t.x,s=e?.y??t.y-t.height/2;tt.push(new Q(i,s,e?.type||"default",{impact:e}))}));const at=[];function ht(t){at.includes(t)||at.push(t)}function lt(){return[...at]}function ct(t,e){const i=lt();i.forEach(((t,s)=>{const r=i[(s+1)%i.length]||null;try{t.update(r,e.ctx,e)}catch(t){console.error("[updateAllStickmen] Error updating stickman:",t)}}))}class dt{constructor(t,e,i,s,n=null,o=!1,a=null){this.x=t,this.y=e,this.prevX=t,this.velocityX=0,this.velocityY=0,this.width=32,this.height=64,this.yBase=e,this.facingRight=s,this.isRunning=!1,this.isJumping=!1,this.mass=1,this.lineWidth=6,this.isNPC=o,this.controls=n,this.aiType=a,this.aiActionCooldown=0,this.aiDecisionIntervalBase=600,this.aiPreferredDistance=180,this.aiBaseAttackProb=.18,this.aiBaseGuardProb=.13,this.aiBaseParryProb=.08,this.aiBaseJumpProb=.07,this.aiTargetX=null,this.aiWantsToAttack=!1,this.aiWantsToGuard=!1,this.aiWantsToParry=!1,this.aiWantsToJump=!1,this.isGuarding=!1,this.isParrying=!1,this.isDodging=!1,this.isAttacking=!1,this.isPerformingSpecialMove=!1,this.specialMoveType=null,this.attackType=null,this.attackTimer=0,this.groundSlamImpactDone=!1,this.hitStunTimer=0,this.dodgeTimer=0,this.dodgeCooldownTimer=0,this.parryTimer=0,this.parryCooldownTimer=0,this.parryFailedVulnTimer=0,this.comboState={count:0,lastAttackTime:0,lastAttackType:null},this.health=100,this.limbImpairDuration=2e3,this.limbs={leftUpperArm:{impairedTimer:0},leftLowerArm:{impairedTimer:0},rightUpperArm:{impairedTimer:0},rightLowerArm:{impairedTimer:0},leftUpperLeg:{impairedTimer:0},leftLowerLeg:{impairedTimer:0},rightUpperLeg:{impairedTimer:0},rightLowerLeg:{impairedTimer:0}},this.colors=i,this.limbSegmentLength=20,this.walkCycleTime=0,this.leftFootPlantedX=null,this.rightFootPlantedX=null,this.activeProceduralAnimation=null,this.currentAngles=this.defaultAngles(),this.targetAngles=this.defaultAngles(),this.animPlayer=new z,this.animPlayer.play(Y,{loop:!0}),r.subscribe("loadPlayerState",(({index:t,state:e})=>{t===gameContext.players.indexOf(this)&&(this.x=e.x,this.y=e.y,this.health=e.health,this.facingRight=e.facingRight)})),ht(this),this.idleTime=0}defaultAngles(){return{leftShoulderZ:0,rightShoulderZ:0,leftElbowZ:0,rightElbowZ:0,leftHipZ:0,rightHipZ:0,leftKneeZ:0,rightKneeZ:0}}getJointPositions(){const{x:t,y:e,width:i,height:s,limbSegmentLength:r}=this,n={x:t,y:e},o={x:t,y:e-.4*s},a={x:o.x-r,y:o.y},h={x:o.x+r,y:o.y},l={x:a.x-r,y:a.y+r},c={x:h.x+r,y:h.y+r},d={x:n.x-r/2,y:n.y+r},u={x:n.x+r/2,y:n.y+r};return{hip:n,neck:o,head:{cx:t,cy:e-.6*s,radius:.5*i},leftShoulder:a,rightShoulder:h,leftElbow:l,rightElbow:c,leftHand:{x:l.x-r,y:l.y},rightHand:{x:c.x+r,y:c.y},leftKnee:d,rightKnee:u,leftFoot:{x:d.x,y:d.y+r},rightFoot:{x:u.x,y:u.y+r}}}getLimbColor(t){return this.colors[t]||"#000"}getLimbHitboxes(){const t=this.getJointPositions(),e={};e.head={type:"circle",cx:t.head?.cx,cy:t.head?.cy,radius:(t.head?.radius||0)+4};const i=(t,e)=>({type:"rect",x:Math.min(t.x,e.x)-4,y:Math.min(t.y,e.y)-4,width:Math.abs(t.x-e.x)+8,height:Math.abs(t.y-e.y)+8});e.torso=i(t.neck,t.hip),this.facingRight?(e.rightUpperArm=i(t.rightShoulder,t.rightElbow),e.rightLowerArm=i(t.rightElbow,t.rightHand),e.leftUpperArm=i(t.leftShoulder,t.leftElbow),e.leftLowerArm=i(t.leftElbow,t.leftHand),e.rightUpperLeg=i(t.hip,t.rightKnee),e.rightLowerLeg=i(t.rightKnee,t.rightFoot),e.leftUpperLeg=i(t.hip,t.leftKnee),e.leftLowerLeg=i(t.leftKnee,t.leftFoot)):(e.leftUpperArm=i(t.leftShoulder,t.leftElbow),e.leftLowerArm=i(t.leftElbow,t.leftHand),e.rightUpperArm=i(t.rightShoulder,t.rightElbow),e.rightLowerArm=i(t.rightElbow,t.rightHand),e.leftUpperLeg=i(t.hip,t.leftKnee),e.leftLowerLeg=i(t.leftKnee,t.leftFoot),e.rightUpperLeg=i(t.hip,t.rightKnee),e.rightLowerLeg=i(t.rightKnee,t.rightFoot));for(const t in e)"rect"===e[t].type&&(e[t].width<8&&(e[t].width=8),e[t].height<8&&(e[t].height=8));return e}draw(t){const e=this.getJointPositions();if(!e||!e.neck)return;t.save(),t.lineCap="round",t.lineJoin="round",t.lineWidth=this.lineWidth,X(t,e.neck,e.hip,this.lineWidth,this.getLimbColor("torso"));const i=this.getLimbColor("head"),s=t.createRadialGradient(e.head.cx,e.head.cy,.3*e.head.radius,e.head.cx,e.head.cy,e.head.radius);if(s.addColorStop(0,i),s.addColorStop(1,"#00000033"),t.fillStyle=s,t.beginPath(),t.arc(e.head?.cx,e.head?.cy,e.head?.radius||0,0,2*Math.PI),t.fill(),t.strokeStyle=this.colors.headOutline||"#000",t.stroke(),X(t,e.leftShoulder,e.leftElbow,this.lineWidth,this.getLimbColor("leftUpperArm")),t.strokeStyle=this.getLimbColor("leftLowerArm"),t.beginPath(),t.moveTo(e.leftElbow.x,e.leftElbow.y),t.lineTo(e.leftHand.x,e.leftHand.y),t.stroke(),X(t,e.rightShoulder,e.rightElbow,this.lineWidth,this.getLimbColor("rightUpperArm")),t.strokeStyle=this.getLimbColor("rightLowerArm"),t.beginPath(),t.moveTo(e.rightElbow.x,e.rightElbow.y),t.lineTo(e.rightHand.x,e.rightHand.y),t.stroke(),X(t,e.hip,e.leftKnee,this.lineWidth,this.getLimbColor("leftUpperLeg")),t.strokeStyle=this.getLimbColor("leftLowerLeg"),t.beginPath(),t.moveTo(e.leftKnee.x,e.leftKnee.y),t.lineTo(e.leftFoot.x,e.leftFoot.y),t.stroke(),X(t,e.hip,e.rightKnee,this.lineWidth,this.getLimbColor("rightUpperLeg")),t.strokeStyle=this.getLimbColor("rightLowerLeg"),t.beginPath(),t.moveTo(e.rightKnee.x,e.rightKnee.y),t.lineTo(e.rightFoot.x,e.rightFoot.y),t.stroke(),"groundSlam"===this.specialMoveType&&this.y>=GROUND_LEVEL-this.height/2-5&&!this.groundSlamImpactDone){t.strokeStyle="rgba(100, 100, 100, 0.7)",t.lineWidth=3;for(let e=0;e<5;e++)t.beginPath(),t.arc(this.x,GROUND_LEVEL,15*(e+1),Math.PI,2*Math.PI),t.stroke()}t.restore()}playAnimation(t,e){this.animPlayer.play(t,e)}solveLegIK(t,e,i){const s=this.limbSegmentLength,r=this.limbSegmentLength,n=t-this.x,o=e-this.y;let a=Math.hypot(n,o);a=Math.min(Math.max(a,Math.abs(s-r)+1e-4),s+r-1e-4);const h=(s*s+a*a-r*r)/(2*s*a),l=Math.atan2(o,n)-Math.acos(h),c=Math.PI-Math.acos((s*s+r*r-a*a)/(2*s*r)),d=i?"left":"right";this.currentAngles[`${d}HipZ`]=l,this.currentAngles[`${d}KneeZ`]=c}updateTargetAngles(){this.targetAngles={...this.currentAngles}}applyProceduralAnimation(t,e,i,s){for(const t in this.targetAngles)this.currentAngles[t]+=.2*(this.targetAngles[t]-this.currentAngles[t])}applyWalkingAngles(t,e,i,s,r){this.currentAngles.leftShoulderZ=-e*t,this.currentAngles.rightShoulderZ=e*t,this.currentAngles.leftElbowZ=i,this.currentAngles.rightElbowZ=i,this.currentAngles.leftHipZ=s*t,this.currentAngles.rightHipZ=-s*t,this.currentAngles.leftKneeZ=r,this.currentAngles.rightKneeZ=r}applyIdleAngles(t,e,i){this.currentAngles.leftShoulderZ+=-e*t,this.currentAngles.rightShoulderZ+=e*t,this.currentAngles.leftElbowZ+=i,this.currentAngles.rightElbowZ+=i}update(t,e,i){const{delta:s,canvasHeight:r}=i,n=this.animPlayer.update(s);for(const t in n)this.currentAngles[t]=n[t];if(Math.abs(this.velocityX)>.1){this.walkCycleTime+=.01*s;const t=this.walkCycleTime,e=.5*Math.sin(t),i=.3*Math.cos(t),r=.4*Math.sin(t),n=.2*Math.cos(t),o=this.facingRight?1:-1;this.applyWalkingAngles(o,e,i,r,n)}else{this.idleTime+=.005*s;const t=.2*Math.sin(this.idleTime),e=.1*Math.cos(this.idleTime),i=this.facingRight?1:-1;this.applyIdleAngles(i,t,e)}this.velocityY+=.001*s,this.y+=this.velocityY,this.x+=this.velocityX;const o=r-this.height/2;this.y>=o&&(this.y=o,this.velocityY=0,this.isJumping=!1),t&&this.canChangeFacing()&&(this.facingRight=t.x>this.x)}canAct(){return this.hitStunTimer<=0&&this.parryFailedVulnTimer<=0&&!this.isDodging&&!this.isParrying&&!this.isAttacking&&!this.isPerformingSpecialMove&&!this.activeProceduralAnimation}canMove(){return!this.isGuarding&&!this.isParrying&&!(this.isPerformingSpecialMove&&"groundSlam"===this.specialMoveType)&&!this.activeProceduralAnimation&&this.hitStunTimer<=0&&this.parryFailedVulnTimer<=0&&!this.isDodging}canChangeFacing(){return!this.isAttacking&&!this.isPerformingSpecialMove&&!this.activeProceduralAnimation&&this.hitStunTimer<=0&&this.parryFailedVulnTimer<=0&&!this.isParrying&&!this.isDodging&&!this.isGuarding}turnAround(){this.canChangeFacing()&&(this.facingRight=!this.facingRight,this.walkCycleTime+=Math.PI,[this.leftFootPlantedX,this.rightFootPlantedX]=[this.rightFootPlantedX,this.leftFootPlantedX],Math.abs(this.velocityX)<.01&&(this.leftFootPlantedX=this.rightFootPlantedX=null),[this.currentAngles.leftShoulderZ,this.currentAngles.rightShoulderZ]=[-this.currentAngles.rightShoulderZ,-this.currentAngles.leftShoulderZ],[this.currentAngles.leftElbowZ,this.currentAngles.rightElbowZ]=[this.currentAngles.rightElbowZ,this.currentAngles.leftElbowZ],[this.currentAngles.leftHipZ,this.currentAngles.rightHipZ]=[-this.currentAngles.rightHipZ,-this.currentAngles.leftHipZ],[this.currentAngles.leftKneeZ,this.currentAngles.rightKneeZ]=[this.currentAngles.rightKneeZ,this.currentAngles.leftKneeZ],[this.targetAngles.leftShoulderZ,this.targetAngles.rightShoulderZ]=[-this.targetAngles.rightShoulderZ,-this.targetAngles.leftShoulderZ],[this.targetAngles.leftElbowZ,this.targetAngles.rightElbowZ]=[this.targetAngles.rightElbowZ,this.targetAngles.leftElbowZ],[this.targetAngles.leftHipZ,this.targetAngles.rightHipZ]=[-this.targetAngles.rightHipZ,-this.targetAngles.leftHipZ],[this.targetAngles.leftKneeZ,this.targetAngles.rightKneeZ]=[this.targetAngles.rightKneeZ,this.targetAngles.leftKneeZ])}jump(t){this.isJumping||(this.velocityY=t,this.isJumping=!0)}initiateAttack(t,e){this.canAct()&&(this.isAttacking=!0,this.attackType=t,this.attackTimer=300,this.activeProceduralAnimation={type:t,startTime:Date.now(),duration:300,startAngles:{...this.currentAngles}},this.isJumping&&"punch"===t&&(this.isPerformingSpecialMove=!0,this.specialMoveType="flyingKick",this.attackTimer=500),this.checkHit(e))}initiateSpecialMove(t,e){this.canAct()&&this.isJumping&&(this.isPerformingSpecialMove=!0,this.specialMoveType=t,this.attackTimer=500,"groundSlam"===t&&(this.velocityY=GROUND_SLAM_FORCE,this.groundSlamImpactDone=!1),this.checkHit(e))}initiateParry(){this.canAct()&&this.parryCooldownTimer<=0&&(this.isParrying=!0,this.parryTimer=PARRY_DURATION,this.parryCooldownTimer=PARRY_COOLDOWN)}initiateAirDodge(t,e){this.canAct()&&this.isJumping&&this.dodgeCooldownTimer<=0&&(this.isDodging=!0,this.dodgeTimer=AIR_DODGE_DURATION,this.dodgeCooldownTimer=AIR_DODGE_COOLDOWN,this.velocityX+=t*AIR_DODGE_FORCE,this.velocityY+=e*AIR_DODGE_FORCE)}checkHit(t){}takeDamage(t,e){this.health=Math.max(0,this.health-t),et(this.x,this.y-.3*this.height,"default",{impact:{x:this.x,y:this.y-.3*this.height}});try{const t=window.gameAssets?.hitSound;if(t){const e=t.cloneNode();e.currentTime=0,e.play().catch((t=>console.warn("SFX play failed:",t)))}}catch(t){console.warn("Error playing hit sound:",t)}r.dispatchEvent("playerHit",{defender:this,attacker:e,impact:{x:this.x,y:this.y-.3*this.height}})}getHitLimbs(t){return["torso"]}facingTowards(t){return this.facingRight&&t.x>this.x||!this.facingRight&&t.x<this.x}getAttackRange(){return"flyingKick"===this.specialMoveType?FLYING_KICK_RANGE:"groundSlam"===this.specialMoveType?GROUND_SLAM_AOE_RANGE:"punch"===this.attackType?PUNCH_RANGE:"kick"===this.attackType?KICK_RANGE:0}getDamage(){return"flyingKick"===this.specialMoveType?FLYING_KICK_DAMAGE:"groundSlam"===this.specialMoveType?GROUND_SLAM_DAMAGE:"punch"===this.attackType?PUNCH_DAMAGE:"kick"===this.attackType?KICK_DAMAGE:0}getKnockback(){let t=this.isPerformingSpecialMove?KNOCKBACK_SPECIAL_MULTIPLIER:1;return{x:KNOCKBACK_BASE_X*t,y:KNOCKBACK_BASE_Y*t}}updateComboState(){const t=Date.now();t-this.comboState.lastAttackTime<=COMBO_WINDOW&&this.comboState.lastAttackType===this.attackType?this.comboState.count++:this.comboState.count=1,this.comboState.lastAttackTime=t,this.comboState.lastAttackType=this.attackType}handleParrySuccess(t){t.hitStunTimer=HIT_STUN_DURATION_HEAVY*PARRY_SUCCESS_STUN_MULTIPLIER,this.parryFailedVulnTimer=PARRY_FAIL_VULNERABLE_DURATION}handleGroundSlamImpact(t){if(this.groundSlamImpactDone)return;this.groundSlamImpactDone=!0;Math.abs(this.x-t.x)<=GROUND_SLAM_AOE_RANGE&&(t.takeDamage(GROUND_SLAM_DAMAGE,this),t.velocityY=2*KNOCKBACK_BASE_Y,t.hitStunTimer=HIT_STUN_DURATION_HEAVY)}aiDecideAction(t){if(!t)return;const e=Math.abs(this.x-t.x);this.aiActionCooldown=this.aiDecisionIntervalBase+200*Math.random(),e<.7*this.aiPreferredDistance?this.aiTargetX=t.x>this.x?this.x-100:this.x+100:e>1.3*this.aiPreferredDistance?this.aiTargetX=t.x:this.aiTargetX=this.x,this.aiWantsToAttack=Math.random()<this.aiBaseAttackProb*(this.aiPreferredDistance/Math.max(e,1)),this.aiWantsToGuard=Math.random()<this.aiBaseGuardProb,this.aiWantsToParry=Math.random()<this.aiBaseParryProb,this.aiWantsToJump=Math.random()<this.aiBaseJumpProb}aiExecuteAction(t,e){if(null!==this.aiTargetX){const t=this.aiTargetX>this.x?1:-1;this.velocityX=Math.min(Math.abs(this.velocityX)+BASE_PLAYER_ACCELERATION,e)*t,Math.abs(this.x-this.aiTargetX)<10&&(this.aiTargetX=null)}if(this.aiWantsToAttack&&this.canAct()){const e=Math.random()<.5?"punch":"kick";this.initiateAttack(e,t),this.aiWantsToAttack=!1}this.aiWantsToGuard&&this.canAct()&&(this.isGuarding=!0),this.aiWantsToParry&&this.canAct()&&(this.initiateParry(),this.aiWantsToParry=!1),this.aiWantsToJump&&!this.isJumping&&this.canAct()&&(this.jump(JUMP_FORCE),this.aiWantsToJump=!1)}}var ut=Object.freeze({__proto__:null,registerStickman:ht,unregisterStickman:function(t){const e=at.indexOf(t);-1!==e&&at.splice(e,1)},getAllStickmen:lt,updateAllStickmen:ct,Stickman:dt,getObstacleDecisionContext:function(t){const e={x:t.x-t.width/2,y:t.y-t.height,width:t.width,height:t.height,facingRight:t.facingRight},i=1.5*t.width,s={x:!1!==t.facingRight?e.x+e.width:e.x-i,y:e.y,width:i,height:e.height},r=y.find((t=>v(s)));return r?r.describe():null}});const pt=Object.create(null),gt=[pt];function ft(t){for(const e of gt)if(e[t])return e[t]}function yt(t,e){if(!t||"function"!=typeof e)throw new Error("registerAIBehavior: Invalid arguments");pt[t]=e,r?.dispatchEvent("aiBehaviorRegistered",{name:t})}class mt{constructor(t,e="basic",i={}){this.entity=t,this.behavior=e,this.options={...i},this.state={},this.debug=i.debug||!1,this.lastDecision=0,this.decisionInterval=i.decisionInterval||100,this.active=!0,this.plugins=[],this.eventHooks=Object.create(null),n.aiControllers.push(this),Et(this),r?.dispatchEvent("aiControllerCreated",{ai:this}),At.push(this)}attachPlugin(t){t&&"object"==typeof t&&!this.plugins.includes(t)&&(this.plugins.push(t),t.onAttach?.(this))}detachPlugin(t){const e=this.plugins.indexOf(t);-1!==e&&(this.plugins.splice(e,1),t.onDetach?.(this))}addEventHook(t,e){this.eventHooks[t]||(this.eventHooks[t]=[]),this.eventHooks[t].push(e)}removeEventHook(t,e){if(!this.eventHooks[t])return;const i=this.eventHooks[t].indexOf(e);-1!==i&&this.eventHooks[t].splice(i,1)}_callEventHooks(t,e){if(this.eventHooks[t])for(const i of this.eventHooks[t])try{i(e,this)}catch(t){this.debug&&console.error("[AIController] Event hook error:",t)}}update(t,e={}){if(!this.active)return;if(this.lastDecision+=t,this.lastDecision<this.decisionInterval)return;this.lastDecision=0;const i={...e,...this.options.context||{}};for(const e of this.plugins)try{e.onUpdate?.(this,t,i)}catch(t){this.debug&&console.error("[AIController] Plugin update error:",t)}const s=ft(this.behavior);if("function"==typeof s)try{s(this.entity,this.state,i,this.options)}catch(t){this.debug&&console.error("[AIController] Behavior error:",t),r?.dispatchEvent("aiError",{ai:this,error:t})}}setBehavior(t){ft(t)&&(this.behavior=t,r?.dispatchEvent("aiBehaviorChanged",{ai:this,behavior:t}))}stop(){this.active=!1}start(){this.active=!0}onEvent(t,e){for(const i of this.plugins)try{i.onEvent?.(this,t,e)}catch(t){this.debug&&console.error("[AIController] Plugin event error:",t)}this._callEventHooks(t,e)}_emitDebug(t,e){a(t,{ai:this,...e}),r?.dispatchEvent("aiDebug",{event:t,ai:this,...e})}}function bt(t,e){let i=null,s=1/0;for(const r of e){if(r===t)continue;const e=Math.hypot(r.x-t.x,r.y-t.y);e<s&&(s=e,i=r)}return{nearest:i,minDist:s}}function wt(t,e){for(const i of e)if(Math.abs(i.x-t.x)<40&&Math.abs(i.y-t.y)<30)return!0;return!1}yt("basic",((t,e,i,s)=>{const{players:r=[],obstacles:n=[],powerups:o=[]}=i;if(!t||!r.length)return;const{nearest:a,minDist:h}=bt(t,r);if(a){a.x<t.x?t.moveLeft?.():a.x>t.x&&t.moveRight?.(),wt(t,n)&&t.jump?.();for(const e of o)Math.hypot(e.x-t.x,e.y-t.y)<30&&t.moveToward?.(e.x,e.y);h<40&&t.attack?.()}})),yt("aggressive",((t,e,i,s)=>{const{players:r=[]}=i;if(!t||!r.length)return;const{nearest:n,minDist:o}=bt(t,r);n&&(n.x<t.x?t.moveLeft?.():n.x>t.x&&t.moveRight?.(),o<60&&t.attack?.())})),yt("defensive",((t,e,i,s)=>{const{players:r=[],obstacles:n=[],powerups:o=[]}=i;if(!t)return;const{nearest:a,minDist:h}=bt(t,r);a&&h<80&&(a.x<t.x?t.moveRight?.():t.moveLeft?.());const{nearestPU:l}=function(t,e){let i=null,s=1/0;for(const r of e){const e=Math.hypot(r.x-t.x,r.y-t.y);e<s&&(s=e,i=r)}return{nearestPU:i,minDistPU:s}}(t,o);l&&t.moveToward?.(l.x,l.y),wt(t,n)&&t.jump?.()}));const vt={getBehaviors:()=>Object.keys(pt),getBehaviorFn:t=>pt[t]};o("aiControllers",n.aiControllers),o("AIController",mt),o("AI_BEHAVIORS",pt),r&&"function"==typeof r.subscribe&&(r.subscribe("powerupCollected",(({player:t,powerup:e})=>{for(const i of n.aiControllers)i.onEvent("powerupCollected",{player:t,powerup:e});a("aiPowerupReact",{player:t,powerup:e})})),r.subscribe("obstacleSpawned",(({obstacle:t})=>{for(const e of n.aiControllers)e.onEvent("obstacleSpawned",{obstacle:t});a("aiObstacleReact",{obstacle:t})})),r.subscribe("playerHit",(({attacker:t,defender:e,damage:i})=>{for(const s of n.aiControllers)s.onEvent("playerHit",{attacker:t,defender:e,damage:i});a("aiPlayerHitReact",{attacker:t,defender:e,damage:i})})));const At=[];function Et(t){At.push(t),r?.dispatchEvent("aiControllerAdded",{ai:t})}function xt(t,e){if(!d||"PLAYING"===d())for(const i of At)i.update(t,e)}let St=!1;var kt=Object.freeze({__proto__:null,AI_BEHAVIORS:pt,injectBehaviorRegistry:function(t){t&&"object"==typeof t&&!gt.includes(t)&&gt.push(t)},registerAIBehavior:yt,unregisterAIBehavior:function(t){pt[t]&&(delete pt[t],r?.dispatchEvent("aiBehaviorUnregistered",{name:t}))},AIController:mt,aiDiagnostics:vt,aiControllers:At,addAIController:Et,removeAIController:function(t){const e=At.indexOf(t);-1!==e&&(At.splice(e,1),r?.dispatchEvent("aiControllerRemoved",{ai:t}))},updateAllAIControllers:xt,getActiveAIControllers:function(){return n.aiControllers.filter((t=>t.active))},getAIControllersByBehavior:function(t){return At.filter((e=>e.behavior===t))},pauseAllAI:function(){if(!St){for(const t of At)t.stop();St=!0}},resumeAllAI:function(){if(St){for(const t of At)t.start();St=!1}},isAIPaused:function(){return St},removeInactiveAIControllers:function(){for(let t=At.length-1;t>=0;t--)At[t].active||At.splice(t,1)},exportAIControllers:function(){return At.map((t=>({entityId:t.entity?.id,behavior:t.behavior,options:{...t.options},state:{...t.state},active:t.active})))},importAIControllers:function(t,e){At.length=0;for(const i of t){const t=e?.(i.entityId);if(t){const e=new mt(t,i.behavior,i.options);e.state=i.state,e.active=i.active,At.push(e)}}}});const Pt=Object.create(null);function Tt(t,e){if(!t||"object"!=typeof e)throw new Error("registerPowerUpType: Invalid arguments");Pt[t]={...e},r?.dispatchEvent("powerupTypeRegistered",{type:t,config:e})}Tt("health",{color:"#4CAF50",effect:(t,e={})=>{t.health=Math.min(t.health+(e.amount||20),t.maxHealth||100)},description:"Restores health.",rarity:1,stackable:!1,icon:"plus"}),Tt("speed",{color:"#2196F3",effect:(t,e={})=>{t.addStatusEffect?.("speed",e.duration||5e3)},description:"Increases speed temporarily.",rarity:2,stackable:!0,icon:"arrow"}),Tt("shield",{color:"#FFC107",effect:(t,e={})=>{t.addStatusEffect?.("shield",e.duration||4e3)},description:"Temporary shield.",rarity:2,stackable:!1,icon:"shield"}),Tt("invincibility",{color:"#E91E63",effect:(t,e={})=>{t.addStatusEffect?.("invincible",e.duration||3e3)},description:"Become invincible for a short time.",rarity:5,stackable:!1,icon:"star"}),Tt("doubleDamage",{color:"#9C27B0",effect:(t,e={})=>{t.addStatusEffect?.("doubleDamage",e.duration||4e3)},description:"Double attack damage.",rarity:3,stackable:!0,icon:"sword"}),Tt("areaHeal",{color:"#00BCD4",effect:(t,e={})=>{e.allPlayers&&e.allPlayers.forEach((t=>t.health=Math.min(t.health+(e.amount||10),t.maxHealth||100)))},description:"Heals all players nearby.",rarity:4,stackable:!1,icon:"heart"});const Ct=Object.freeze({IDLE:"idle",FALLING:"falling",COLLECTED:"collected",EXPIRED:"expired"});class Mt{constructor(t,e,i,s="health",r={}){this.x=t,this.y=e,this.radius=i,this.type=s,this.options={...r};const n=Pt[s]||{};this.color=r.color||n.color||"#FFF",this.icon=r.icon||n.icon||null,this.active=!0,this.spawnTime=Date.now(),this.id=r.id||`powerup_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,this.effect=r.effect||n.effect,this.description=r.description||n.description||"",this.fallSpeed=r.fallSpeed||2.5,this.lifetime=r.lifetime||15e3,this.debug=r.debug||!1,this.rarity=r.rarity||n.rarity||1,this.stackable=r.stackable??n.stackable??!1,this.state=Ct.FALLING,this.collectedBy=null,this.expired=!1,this.visual=r.visual||null,this.sound=r.sound||n.sound||null,this.meta={...n.meta||{},...r.meta||{}}}draw(t){if(!t)throw new Error("PowerUp.draw: ctx is required");if(t.save(),t.globalAlpha=this.active?1:.5,t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fill(),t.strokeStyle="#FFF",t.lineWidth=2,"function"==typeof this.visual)this.visual(t,this);else if("plus"===this.icon||"health"===this.type)t.beginPath(),t.moveTo(this.x-this.radius/2,this.y),t.lineTo(this.x+this.radius/2,this.y),t.moveTo(this.x,this.y-this.radius/2),t.lineTo(this.x,this.y+this.radius/2),t.stroke();else if("arrow"===this.icon||"speed"===this.type)t.beginPath(),t.moveTo(this.x-this.radius/3,this.y),t.lineTo(this.x+this.radius/3,this.y),t.stroke();else if("shield"===this.icon||"shield"===this.type)t.beginPath(),t.arc(this.x,this.y,.6*this.radius,Math.PI,2*Math.PI),t.lineTo(this.x+.6*this.radius,this.y),t.stroke();else if("star"===this.icon||"invincibility"===this.type){t.save(),t.translate(this.x,this.y),t.rotate(Math.PI/10),t.beginPath();for(let e=0;e<5;e++)t.lineTo(0,.7*-this.radius),t.rotate(Math.PI/5),t.lineTo(0,.3*-this.radius),t.rotate(Math.PI/5);t.closePath(),t.stroke(),t.restore()}t.restore()}update(t,e){this.active&&this.state===Ct.FALLING&&(this.y+=this.fallSpeed*(t/(1e3/60)),this.y-this.radius>e&&(this.active=!1,this.state=Ct.EXPIRED,this.expired=!0,r?.dispatchEvent("powerupExpired",{powerup:this})),Date.now()-this.spawnTime>this.lifetime&&(this.active=!1,this.state=Ct.EXPIRED,this.expired=!0,r?.dispatchEvent("powerupExpired",{powerup:this})))}apply(t,e={}){if(this.active&&this.state===Ct.FALLING)try{this.effect?.(t,e),this.active=!1,this.state=Ct.COLLECTED,this.collectedBy=t,this.sound&&this.playSound(),r?.dispatchEvent("powerupCollected",{powerup:this,player:t})}catch(t){r?.dispatchEvent("powerupError",{powerup:this,error:t}),this.debug&&console.error("[PowerUp] Error applying effect:",t)}}playSound(){if("function"==typeof this.sound)this.sound();else if("undefined"!=typeof window&&this.sound){new window.Audio(this.sound).play()}}serialize(){return{id:this.id,type:this.type,x:this.x,y:this.y,radius:this.radius,color:this.color,icon:this.icon,active:this.active,state:this.state,description:this.description,options:{...this.options},debug:this.debug,rarity:this.rarity,stackable:this.stackable,meta:{...this.meta}}}static deserialize(t){return new Mt(t.x,t.y,t.radius,t.type,t.options)}describe(){return this.serialize()}}const It=[];function Lt(t){if(!(t instanceof Mt))throw new TypeError("addPowerUp: argument must be a PowerUp");It.push(t),r?.dispatchEvent("powerupAdded",{powerup:t})}function Dt(){It.length=0,r?.dispatchEvent("powerupsCleared")}function Ot(t,e){for(const i of It)i.update(t,e)}function Rt(t,e){d&&"PLAYING"!==d()||Ot(t,e?.canvasHeight||400)}function _t(t){for(const e of It)e.draw(t)}r?.subscribe?.("powerupAdded",(({powerup:t})=>{!d||d()})),r?.subscribe?.("screenStateChanged",(({state:t})=>{window?.DEBUG_MODE&&console.debug(`[PowerUps] Screen state changed to: ${t}`)}));var Ut=Object.freeze({__proto__:null,POWERUP_TYPES:Pt,registerPowerUpType:Tt,unregisterPowerUpType:function(t){Pt[t]&&(delete Pt[t],r?.dispatchEvent("powerupTypeUnregistered",{type:t}))},PowerUpState:Ct,PowerUp:Mt,powerUps:It,addPowerUp:Lt,removePowerUpById:function(t){const e=It.findIndex((e=>e.id===t));if(-1!==e){const[t]=It.splice(e,1);return r?.dispatchEvent("powerupRemoved",{powerup:t}),t}return null},clearPowerUps:Dt,updatePowerUps:Ot,updateAllPowerUps:Rt,drawAllPowerUps:_t,getPowerUpAtPoint:function(t,e){return It.find((i=>i.active&&Math.hypot(i.x-t,i.y-e)<=i.radius))||null},getActivePowerUps:function(){return It.filter((t=>t.active))},describeAllPowerUps:function(){return It.map((t=>t.describe()))},getPowerUpsByType:function(t){return It.filter((e=>e.type===t))},getPowerUpsByState:function(t){return It.filter((e=>e.state===t))},spawnRandomPowerUp:function(t,e,i=16,s={}){const n=Object.entries(Pt),o=n.reduce(((t,[e,i])=>t+(i.rarity||1)),0);let a=Math.random()*o;for(const[o,h]of n)if(a-=h.rarity||1,a<=0){const n=new Mt(t,e,i,o,s);return Lt(n),r?.dispatchEvent("powerupSpawned",{powerup:n}),n}const h=new Mt(t,e,i,"health",s);return Lt(h),r?.dispatchEvent("powerupSpawned",{powerup:h}),h},serializeAllPowerUps:function(){return It.map((t=>t.serialize()))},loadPowerUpsFromData:function(t){Dt();for(const e of t)Lt(Mt.deserialize(e))}});window.eventManager=r,window.gameContext=n,window.setMenuState=function(t){n.menuState=t,r?.dispatchEvent("showMenu",{state:t})},window.registerSystem=o,window.broadcastGameEvent=function(t,e){r?.dispatchEvent(t,e)},window.logDiagnostic=a;const Kt=document.createElement("div");Kt.id="loadingOverlay",Kt.className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-75 text-white text-lg z-50",Kt.innerText="Loading… 0%",document.body.appendChild(Kt),function(e){const i=t.map((i=>new Promise(((t,e)=>{if("image"===i.type){const s=new window.Image;s.src=i.path,s.onload=()=>t({key:i.key,data:s}),s.onerror=e}else if("audio"===i.type){const s=new window.Audio;s.src=i.path,s.oncanplaythrough=()=>t({key:i.key,data:s}),s.onerror=e}else fetch(i.path).then((t=>t.json())).then((e=>t({key:i.key,data:e}))).catch(e)})).then((s=>(e&&e(t.indexOf(i)+1,t.length),s)))));return Promise.all(i)}(((t,e)=>{Kt.innerText=`Loading… ${Math.floor(t/e*100)}%`})).then((t=>{window.gameAssets=Object.fromEntries(t.map((t=>[t.key,t.data]))),document.body.removeChild(Kt),function(t,e=800,i=400){const s=document.getElementById(t);if(!s)throw new Error(`Canvas with ID ${t} not found.`);function r(){const t=Math.max(Math.floor(window.innerWidth/e),Math.floor(window.innerHeight/i))||1;s.style.width=e*t+"px",s.style.height=i*t+"px",s.width=e,s.height=i}window.addEventListener("resize",r),r()}("gameCanvas",800,400);const e=s();e&&window.eventManager?.dispatchEvent("restoreGame",e),W(),window.stickman=ut,window.controls={initControls:W,onControlsChanged:G},window.ai=kt,window.obstacles=k,window.powerups=Ut,window.dispatchEvent(new Event("stickFighterAppReady")),import("./index-25fb385f.js")})).catch((t=>{console.error("Asset preload failed:",t),Kt.innerText="Failed to load resources. Check console."}));export{dt as S,n as a,At as b,lt as c,d,r as e,S as f,I as g,ct as h,Rt as i,nt as j,E as k,s as l,ot as m,_t as n,p as o,a as p,u as q,o as r,i as s,g as t,xt as u};
//# sourceMappingURL=bootstrap.js.map
