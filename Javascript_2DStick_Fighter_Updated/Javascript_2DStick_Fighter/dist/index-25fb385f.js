import{e,g as t,o as n,r as o,a as r,b as a,c as s,s as i,l,d as c,u,f as d,h,i as p,j as f,k as y,m,n as g,p as b,q as w,t as v,S as E}from"./bootstrap.js";let M=null,D=null,x=null;const C={left:"Move Left",right:"Move Right",jump:"Jump",punch:"Punch",kick:"Kick",guard:"Guard",slam:"Slam",airDodge:"Air Dodge",parry:"Parry",run:"Run",turn:"Turn"};function I(e,t){try{D||D||(D=document.createElement("div"),D.className="tooltip",document.body.appendChild(D)),D.textContent=e,D.classList.add("visible");const n=t.getBoundingClientRect();let o=n.left+n.width/2,r=n.bottom+8;const a=D.getBoundingClientRect();o+a.width/2>window.innerWidth&&(o=window.innerWidth-a.width/2-8),o-a.width/2<0&&(o=a.width/2+8),r+a.height>window.innerHeight&&(r=n.top-a.height-8),D.style.left=`${o}px`,D.style.top=`${r}px`}catch(e){console.warn("[controlsInfo] Tooltip error:",e)}}function S(){D&&D.classList.remove("visible")}function L(e){if(!M)return;const t=Array.from(M.querySelectorAll(".control-key")),n=document.activeElement,o=t.indexOf(n);"ArrowRight"===e.key||"ArrowDown"===e.key?(-1!==o&&t[(o+1)%t.length].focus(),e.preventDefault()):"ArrowLeft"===e.key||"ArrowUp"===e.key?(-1!==o&&t[(o-1+t.length)%t.length].focus(),e.preventDefault()):"Escape"===e.key&&(H(),e.preventDefault())}function B(){try{let e=document.getElementById("controlsInfo");e?(M=e,M.className="controls-info",M.setAttribute("tabindex","0"),M.setAttribute("aria-label","Game Controls Information"),M.setAttribute("role","region"),M.style.position="relative",M.style.opacity="0",M.style.transition="opacity 0.4s",console.debug("[controlsInfo] Found #controlsInfo container in DOM.")):M||(M=document.createElement("section"),M.className="controls-info",M.setAttribute("tabindex","0"),M.setAttribute("aria-label","Game Controls Information"),M.setAttribute("role","region"),M.style.position="relative",M.style.opacity="0",M.style.transition="opacity 0.4s",document.body.appendChild(M),console.debug("[controlsInfo] Created fallback controls-info container."));const n=t();if(!n?.player1||!n?.player2)return M.innerHTML="<div style='color:#b91c1c'>Controls info unavailable: Key bindings missing.</div>",void console.warn("[controlsInfo] Key bindings missing, cannot render controls info.");M.innerHTML=`\n      <h3>Controls</h3>\n      <div style="display: flex; gap: 32px; flex-wrap: wrap; justify-content: center;">\n        <div>\n          <strong>Player 1</strong>\n          <ul role="list">\n            ${Object.entries(n.player1).map((([e,t])=>`\n              <li role="listitem">\n                <button class="control-key" data-action="${e}" data-player="1" tabindex="0" aria-label="${C[e]||e}">\n                  <code>${t.replace("Key","")}</code>\n                  <span class="visually-hidden">${C[e]||e}</span>\n                </button>\n                <span style="margin-left: 8px;">${C[e]||e}</span>\n              </li>\n            `)).join("")}\n          </ul>\n        </div>\n        <div>\n          <strong>Player 2</strong>\n          <ul role="list">\n            ${Object.entries(n.player2).map((([e,t])=>`\n              <li role="listitem">\n                <button class="control-key" data-action="${e}" data-player="2" tabindex="0" aria-label="${C[e]||e}">\n                  <code>${t.replace("Key","")}</code>\n                  <span class="visually-hidden">${C[e]||e}</span>\n                </button>\n                <span style="margin-left: 8px;">${C[e]||e}</span>\n              </li>\n            `)).join("")}\n          </ul>\n        </div>\n      </div>\n      <p style="margin-top:16px;font-size:0.95em;">Tip: Hover or focus a key for details. Controls can be remapped in settings.</p>\n    `,M.appendChild(x||(x=document.createElement("button"),x.className="controls-info-close",x.setAttribute("aria-label","Close controls info"),x.innerHTML="&times;",x.style.position="absolute",x.style.top="8px",x.style.right="12px",x.style.background="none",x.style.border="none",x.style.fontSize="1.5em",x.style.cursor="pointer",x.style.color="var(--theme-accent-dark, #2563eb)",x.addEventListener("click",H),x)),M.querySelectorAll(".control-key").forEach((e=>{e.addEventListener("mouseenter",(t=>{const n=e.dataset.action;I(C[n]||n,e)})),e.addEventListener("mouseleave",S),e.addEventListener("focus",(t=>{const n=e.dataset.action;I(C[n]||n,e)})),e.addEventListener("blur",S)})),M.onkeydown=L,setTimeout((()=>{M.style.opacity="1"}),10),console.debug("[controlsInfo] Controls info rendered successfully.")}catch(e){M&&(M.innerHTML=`<div style="color:#b91c1c">Error loading controls info: ${e.message}</div>`),console.warn("[controlsInfo] Render error:",e)}}function A(){try{M||B(),M.style.display="",setTimeout((()=>{M.style.opacity="1"}),10),M.focus()}catch(e){console.warn("[controlsInfo] Show error:",e)}}function H(){try{M&&(M.style.opacity="0",setTimeout((()=>{M&&(M.style.display="none")}),400)),S()}catch(e){console.warn("[controlsInfo] Hide error:",e)}}function T(e){B()}n((e=>{const t=document.querySelector(".controls-info");t&&(t.style.display="MENU"===e||"SETTINGS_MENU"===e?"block":"none")})),e&&"function"==typeof e.subscribe&&(e.subscribe("settingsChanged",(({settings:e})=>{T()})),e.subscribe("keyBindingsChanged",(({bindings:e})=>{B()})),e.subscribe("showControlsRemap",(()=>{A()}))),window.controlsInfoUI={renderControlsInfo:B,showControlsInfo:A,hideControlsInfo:H,applySettings:T};try{window.menuDebug&&"function"==typeof window.menuDebug.onMenuEvent&&window.menuDebug.onMenuEvent("showMenu",(({state:e})=>{"SETTINGS_MENU"===e?A():H()})),window.messageDisplayDebug?.onMessageEvent&&window.messageDisplayDebug.onMessageEvent("show",(({message:e,opts:t})=>{e?.toLowerCase().includes("controls")&&A()}))}catch(e){console.warn("[controlsInfo] UI integration error:",e)}const U=[1,2],k=["player1HealthBarInner","player2HealthBarInner"],N=["Player 1 Health","Player 2 Health"];function $(e){return document.getElementById(k[e])}function P(){return document.getElementById("healthBars")}function G(e){return e&&"number"==typeof e.health&&"number"==typeof e.maxHealth&&0!==e.maxHealth?Math.max(0,Math.min(1,e.health/e.maxHealth)):0}function _(){U.forEach(((e,t)=>{const n=$(t);n&&(n.style.width="100%",n.classList.remove("low-health","heal-effect","damage-effect"),n.setAttribute("aria-valuenow",100))}))}function O(e){try{let t;t=void 0!==e.playerIndex?e.playerIndex:2===e.id?1:0;const n=$(t);if(!n)return void console.warn(`[healthBar] No health bar found for player index ${t}`);const o=G(e);console.debug(`[healthBar] Player ${t+1}: health=${e.health}, maxHealth=${e.maxHealth}, percent=${(100*o).toFixed(1)}%, barWidth=${n.style.width}`)}catch(e){console.warn("[healthBar] logHealthBarState error:",e)}}function F(){if(!P())return console.error("[healthBar] Health bar container not found in DOM."),!1;for(const e of k)if(!document.getElementById(e))return console.error(`[healthBar] Health bar inner element missing: ${e}`),!1;return!0}function R(e){try{if(!e||"number"!=typeof e.health||"number"!=typeof e.maxHealth)return;let t;t=void 0!==e.playerIndex?e.playerIndex:2===e.id?1:0;const n=$(t);if(!n)return void console.warn(`[healthBar] No health bar found for player index ${t}`);const o=G(e);n.style.width=100*o+"%",n.setAttribute("aria-valuenow",Math.round(100*o)),n.setAttribute("aria-valuemax",100),n.setAttribute("aria-label",N[t]),o<=.25?n.classList.add("low-health"):n.classList.remove("low-health"),void 0!==e._lastHealth&&(e.health>e._lastHealth?(n.classList.add("heal-effect"),setTimeout((()=>n.classList.remove("heal-effect")),500)):e.health<e._lastHealth&&(n.classList.add("damage-effect"),setTimeout((()=>n.classList.remove("damage-effect")),500))),e._lastHealth=e.health,O(e)}catch(e){console.warn("[healthBar] Update error:",e)}}function j(){const e=P();e&&(e.style.display="flex")}function q(){const e=P();e&&(e.style.display="none")}function Y(e,t,n="score"){const o=$(e);if(!o)return;let r=document.createElement("span");r.className=`score-popup ${n}`;let a="";a="combo"===n?"Combo! +"+t:t>0?"+"+t:t,r.textContent=a,o.appendChild(r),setTimeout((()=>{r.classList.add("fade"),setTimeout((()=>r.remove()),600)}),10)}function W(e,t){k.forEach(((n,o)=>{const r=document.getElementById(n);r&&(r.classList.remove("winner","loser"),o===e&&r.classList.add("winner"),o===t&&r.classList.add("loser"))}))}function K(){k.forEach((e=>{const t=document.getElementById(e);t&&t.classList.remove("winner","loser")}))}function Q(e){let t=document.getElementById("roundTimerBar");if(!t){const e=P();if(!e)return;t=document.createElement("div"),t.id="roundTimerBar",t.className="round-timer-bar",e.appendChild(t)}t.style.width=`${Math.max(0,Math.min(100,100*e))}%`}function z(e){e&&e.classList.add("visually-hidden")}function J(e){e&&e.classList.remove("visually-hidden")}function V(e=[]){const t=P();t&&(t.innerHTML='\n    <div id="player1HealthBar" class="health-bar player-1-health" role="progressbar" aria-label="Player 1 Health">\n      <div id="player1HealthBarInner" class="health-bar-inner" aria-valuenow="100" aria-valuemax="100" aria-label="Player 1 Health"><span class="visually-hidden">Player 1 Health</span></div>\n    </div>\n    <div id="player2HealthBar" class="health-bar player-2-health" role="progressbar" aria-label="Player 2 Health">\n      <div id="player2HealthBarInner" class="health-bar-inner" aria-valuenow="100" aria-valuemax="100" aria-label="Player 2 Health"><span class="visually-hidden">Player 2 Health</span></div>\n    </div>\n  ',e.forEach(R),k.forEach(((e,t)=>{const n=document.getElementById(e);if(!n)return;n.setAttribute("tabindex","0"),n.setAttribute("role","tooltip"),n.setAttribute("aria-describedby",`healthBarTooltip${t}`);let o=document.createElement("span");o.className="health-bar-tooltip",o.id=`healthBarTooltip${t}`,o.textContent=N[t],n.appendChild(o),n.addEventListener("focus",(()=>o.classList.add("show"))),n.addEventListener("blur",(()=>o.classList.remove("show"))),n.addEventListener("mouseenter",(()=>o.classList.add("show"))),n.addEventListener("mouseleave",(()=>o.classList.remove("show")))})),Q(1))}const X={};function Z(e,t){"string"==typeof e&&"function"==typeof t&&(X[e]||(X[e]=[]),X[e].push(t))}function ee(e,t){X[e]&&(X[e]=X[e].filter((e=>e!==t)))}function te(e,t={}){try{!function(e,t){X[e]&&X[e].forEach((n=>{try{n(t)}catch(t){console.error(`[healthBar] Error in custom event listener for ${e}:`,t)}}))}(e,t),window?.DEBUG_MODE&&console.debug(`[healthBar] Dispatched event: ${e}`,t)}catch(t){console.error(`[healthBar] Error dispatching event (${e}):`,t)}}n((e=>{"PLAYING"===e||"PAUSED"===e?j():q()})),window.healthBarDebug={getHealthBarEl:$,getHealthBarContainer:P,updateHealthBar:R,renderHealthBars:V,showHealthBars:j,hideHealthBars:q,getHealthPercent:G,resetHealthBars:_,logHealthBarState:O,ensureHealthBarDOM:F,showScorePopup:Y,setWinnerLoserEffect:W,updateRoundTimerBar:Q,visuallyHide:z,visuallyShow:J,onHealthBarEvent:Z,offHealthBarEvent:ee,dispatchHealthBarEvent:te,healthBarEventListeners:X,clearWinnerLoserEffect:K},e&&"function"==typeof e.subscribe&&(e.subscribe("playerHit",(({defender:e})=>R(e))),e.subscribe("playerHealed",(({player:e})=>R(e))),e.subscribe("fightStart",(({players:e})=>{V(e),j()})),e.subscribe("fightEnd",(()=>q())),e.subscribe("playerDefeated",(({winner:e,loser:t})=>{e&&t&&void 0!==e.playerIndex&&void 0!==t.playerIndex&&W(e.playerIndex,t.playerIndex)})),e.subscribe("fightStart",(()=>K())),e.subscribe("scorePopup",(({playerIdx:e,value:t,type:n})=>Y(e,t,n))),e.subscribe("comboPopup",(({playerIdx:e,value:t})=>Y(e,t,"combo"))),e.subscribe("winnerLoser",(({winnerIdx:e,loserIdx:t})=>W(e,t))),e.subscribe("roundTimer",(({percent:e})=>Q(e)))),window.healthBarUI={updateHealthBar:function(e){try{R(e)}catch(e){console.warn("[healthBar] safeUpdateHealthBar error:",e)}},renderHealthBars:V,showHealthBars:j,hideHealthBars:q,getHealthPercent:G,resetHealthBars:_,logHealthBarState:O,ensureHealthBarDOM:F,showScorePopup:function(e,t,n="score"){try{Y(e,t,n)}catch(e){console.warn("[healthBar] safeShowScorePopup error:",e)}},setWinnerLoserEffect:function(e,t){try{W(e,t)}catch(e){console.warn("[healthBar] safeSetWinnerLoserEffect error:",e)}},updateRoundTimerBar:function(e){try{Q(e)}catch(e){console.warn("[healthBar] safeUpdateRoundTimerBar error:",e)}},visuallyHide:z,visuallyShow:J,onHealthBarEvent:Z,offHealthBarEvent:ee,dispatchHealthBarEvent:te,clearWinnerLoserEffect:K};const ne=["MENU","MODE_SELECT","DIFFICULTY_SELECT","PAUSED","SETTINGS_MENU","END"];let oe="MENU";const re={MENU:[{id:"start",text:"Start Game",color:"#60a5fa",hoverColor:"#3b82f6",textColor:"#fff"}],MODE_SELECT:[{id:"pvp",text:"Player vs Player",color:"#34d399",hoverColor:"#10b981",textColor:"#fff"},{id:"pvc",text:"Player vs Computer",color:"#fbbf24",hoverColor:"#f59e0b",textColor:"#92400e"}],DIFFICULTY_SELECT:[{id:"easy",text:"Easy",color:"#a7f3d0",hoverColor:"#6ee7b7",textColor:"#065f46"},{id:"medium",text:"Medium",color:"#fcd34d",hoverColor:"#fbbf24",textColor:"#92400e"},{id:"hard",text:"Hard",color:"#f87171",hoverColor:"#ef4444",textColor:"#991b1b"}],PAUSED:[{id:"resume",text:"Resume",color:"#34d399",hoverColor:"#10b981",textColor:"#fff"},{id:"pauseSettings",text:"Settings",color:"#fbbf24",hoverColor:"#f59e0b",textColor:"#fff"},{id:"pauseMainMenu",text:"Main Menu",color:"#f87171",hoverColor:"#ef4444",textColor:"#fff"}],SETTINGS_MENU:[{id:"settingsBack",text:"Back",color:"#60a5fa",hoverColor:"#3b82f6",textColor:"#fff"},{id:"gravityLow",text:"Gravity: Low",color:"#fbbf24",hoverColor:"#fde68a",textColor:"#92400e"},{id:"gravityNormal",text:"Gravity: Normal",color:"#60a5fa",hoverColor:"#3b82f6",textColor:"#2563eb"},{id:"gravityHigh",text:"Gravity: High",color:"#ef4444",hoverColor:"#f87171",textColor:"#fff"}],END:[{id:"endMainMenu",text:"Main Menu",color:"#60a5fa",hoverColor:"#3b82f6",textColor:"#fff"}]};let ae=null;function se(){return ae||(ae=function(){const e=document.createElement("div");return e.className="menu-overlay",e.setAttribute("role","dialog"),e.setAttribute("aria-modal","true"),e.setAttribute("tabindex","-1"),e.style.display="none",document.body.appendChild(e),e}()),ae}function ie(e){return ne.includes(e)}function le(e){return"string"==typeof e&&(["menuStart","menuModeSelect","menuDifficultySelect","menuMainMenu","settingsChanged","pause","resume","gameOver","showMenu"].includes(e)||e in ye)}function ce(e){try{if(!ie(e))return void console.warn(`[menu] Attempted to update to invalid state: ${e}`);oe=e,ue(e)}catch(e){console.error("[menu] Error updating menu state:",e)}}function ue(e=oe){try{const t=se();if(function(){const e=se();e.innerHTML="",e.classList.remove("active"),e.style.display="none"}(),!ie(e))return void console.warn(`[menu] Invalid menu state: ${e}`);const n=re[e]||[],o=function(e){switch(e){case"MENU":return"Stick Fighter";case"MODE_SELECT":return"Select Mode";case"DIFFICULTY_SELECT":return"Select Difficulty";case"PAUSED":return"Paused";case"SETTINGS_MENU":return"Settings";case"END":return"Game Over";default:return""}}(e);if(o){const e=document.createElement("h2");e.className="menu-overlay-text",e.textContent=o,t.appendChild(e)}n.forEach((n=>{if(function(e){return e&&"string"==typeof e.id&&"string"==typeof e.text}(n))try{const o=function(e,t){const n=document.createElement("button");return n.className="menu-button",n.id=e.id,n.textContent=e.text,n.style.background=e.color,n.style.color=e.textColor,n.setAttribute("tabindex","0"),n.setAttribute("aria-label",e.text),n.addEventListener("mouseenter",(()=>n.style.background=e.hoverColor)),n.addEventListener("mouseleave",(()=>n.style.background=e.color)),n.addEventListener("click",t),n}(n,(()=>{pe("buttonClick",{id:n.id,state:e}),De(n.id)}));t.appendChild(o)}catch(e){console.error(`[menu] Error rendering button ${n.id}:`,e)}else console.warn("[menu] Invalid button definition:",n)})),t.style.display="block",setTimeout((()=>{!function(){const e=se();e.classList.add("active")}(),function(){const e=se().querySelector("button");e&&e.focus()}(),function(){const e=se();e.querySelectorAll("button").forEach((e=>{e.removeEventListener("mouseenter",e._menuTooltipEnter),e.removeEventListener("mouseleave",e._menuTooltipLeave),e._menuTooltipEnter=()=>e.setAttribute("title",e.textContent),e._menuTooltipLeave=()=>e.removeAttribute("title"),e.addEventListener("mouseenter",e._menuTooltipEnter),e.addEventListener("mouseleave",e._menuTooltipLeave)}))}()}),10),t.focus(),pe("menuShown",{state:e})}catch(e){console.error("[menu] Error rendering menu:",e)}}function de(e){ye[e]&&(ye[e].length=0)}function he(){Object.keys(ye).forEach((e=>{ye[e].length=0}))}function pe(e,t){window?.DEBUG_MODE&&console.debug(`[MENU ANALYTICS] ${e}`,t)}function fe(){try{const e=se();if(!e)return;se().classList.remove("active"),setTimeout((()=>{e&&(e.style.display="none")}),400),pe("menuHidden",{state:oe})}catch(e){console.error("[menu] Error hiding menu:",e)}}const ye={};function me(e,t){le(e)?(ye[e]||(ye[e]=[]),ye[e].push(t)):console.warn("[menu] Attempted to register invalid event type:",e)}function ge(e,t){le(e)&&ye[e]&&(ye[e]=ye[e].filter((e=>e!==t)))}function be(t,n={}){try{if(!le(t))return void console.warn("[menu] Attempted to dispatch invalid event type:",t);e&&"function"==typeof e.dispatchEvent?(e.dispatchEvent(t,n),pe("eventDispatched",{eventType:t,detail:n})):console.warn("[menu] EventManager not available for event:",t,n),function(e,t){ye[e]&&ye[e].forEach((n=>{try{n(t)}catch(t){console.error(`[menu] Error in custom menu event listener for ${e}:`,t)}}))}(t,n)}catch(e){console.error(`[menu] Error dispatching event (${t}):`,e)}}function we(e,t){me(e,(function n(o){ge(e,n),t(o)}))}const ve=[];function Ee(e,t={}){ve.push({eventType:e,detail:t})}function Me(){for(;ve.length>0;){const e=ve.shift();be(e.eventType,e.detail)}}function De(e){try{switch(e){case"start":be("menuStart",{}),fe();break;case"pvp":be("menuModeSelect",{mode:"PvP"}),fe();break;case"pvc":ce("DIFFICULTY_SELECT");break;case"easy":case"medium":case"hard":be("menuDifficultySelect",{difficulty:e}),fe();break;case"resume":be("resume",{}),fe();break;case"pauseSettings":ce("SETTINGS_MENU");break;case"pauseMainMenu":case"endMainMenu":be("menuMainMenu",{}),be("resetKeyBindings",{}),fe();break;case"settingsBack":ce("PAUSED");break;case"gravityLow":be("settingsChanged",{gravity:"low"});break;case"gravityNormal":be("settingsChanged",{gravity:"normal"});break;case"gravityHigh":be("settingsChanged",{gravity:"high"});break;default:console.warn(`[menu] Unhandled menu action: ${e}`)}}catch(t){console.error(`[menu] Error handling menu action (${e}):`,t)}}!function(){if(!e||"function"!=typeof e.subscribe)return;["menuStart","menuModeSelect","menuDifficultySelect","menuMainMenu","settingsChanged","pause","resume","gameOver","showMenu"].forEach((t=>{e.subscribe(t,(e=>{pe("eventReceived",{event:t,detail:e})}))}))}(),document.addEventListener("keydown",(e=>{try{if(!ae||"block"!==ae.style.display)return;const t=Array.from(ae.querySelectorAll("button")),n=t.indexOf(document.activeElement);"ArrowDown"===e.key||"Tab"===e.key?(t[(n+1)%t.length]?.focus(),e.preventDefault()):"ArrowUp"===e.key?(t[(n-1+t.length)%t.length]?.focus(),e.preventDefault()):"Escape"===e.key&&("SETTINGS_MENU"===oe?ce("PAUSED"):"PAUSED"!==oe&&"END"!==oe||fe(),e.preventDefault())}catch(e){console.error("[menu] Keyboard navigation error:",e)}})),e&&"function"==typeof e.subscribe&&(e.subscribe("pause",(()=>ce("PAUSED"))),e.subscribe("resume",(()=>fe())),e.subscribe("gameOver",(()=>ce("END"))),e.subscribe("showMenu",(({state:e})=>ce(e)))),window.menuDebug={getState:()=>oe,getOverlay:()=>se(),showMenu:ue,hideMenu:fe,updateMenuState:ce,MENU_STATES:ne,MENU_BUTTONS:re,onMenuEvent:me,offMenuEvent:ge,onceMenuEvent:we,queueMenuEvent:Ee,processMenuEventQueue:Me,menuEventListeners:ye,menuEventQueue:ve,clearMenuEventListeners:de,clearAllMenuEventListeners:he},window.menuUI={renderMenu:ue,hideMenu:fe,updateMenuState:ce,handleMenuAction:De,MENU_STATES:ne,MENU_BUTTONS:re,onMenuEvent:me,offMenuEvent:ge,onceMenuEvent:we,queueMenuEvent:Ee,processMenuEventQueue:Me,menuEventListeners:ye,menuEventQueue:ve,clearMenuEventListeners:de,clearAllMenuEventListeners:he};let xe=null,Ce=null;function Ie(){return xe||(xe=document.getElementById("messageDisplay"),xe||(xe=document.createElement("div"),xe.id="messageDisplay",document.body.appendChild(xe)),xe.setAttribute("role","status"),xe.setAttribute("aria-live","polite"),xe.setAttribute("tabindex","-1"),xe.className="",xe.style.display="none",xe.addEventListener("keydown",(e=>{"Escape"===e.key&&Le()}))),xe}function Se(e,t={}){try{if("string"!=typeof e||!e.trim())throw new Error("Message must be a non-empty string");const n=Ie();if(!n)throw new Error("Message container not found");clearTimeout(Ce),n.textContent=e,n.className="active",n.style.display="block",n.setAttribute("aria-label",e);try{n.focus()}catch(e){console.warn("[messageDisplay] Focus error:",e)}if(t.critical&&n.classList.add("critical"),_e.push({message:e,opts:t,timestamp:Date.now()}),0!==t.duration)Ce=setTimeout((()=>{try{Le(),"function"==typeof t.onHide&&t.onHide()}catch(e){console.warn("[messageDisplay] Error in hideMessage/onHide:",e)}}),t.duration||2500);else if("function"==typeof t.onHide){const e=Le;Le=function(){try{e(),t.onHide()}catch(e){console.warn("[messageDisplay] Error in persistent onHide:",e)}finally{Le=e}}}window?.DEBUG_MODE&&console.debug("[messageDisplay] showMessage:",e,t),Te("show",{message:e,opts:t})}catch(e){console.warn("[messageDisplay] Show error:",e);try{const e=Ie();e&&(e.textContent="Error displaying message.",e.className="active critical",e.style.display="block")}catch{}}}function Le(){try{const e=Ie();if(!e)throw new Error("Message container not found");e.classList.remove("active","critical"),e.style.opacity="0",setTimeout((()=>{try{e.style.display="none",e.textContent="",e.style.opacity=""}catch(e){console.warn("[messageDisplay] Error clearing message:",e)}}),400),window?.DEBUG_MODE&&console.debug("[messageDisplay] hideMessage")}catch(e){console.warn("[messageDisplay] Hide error:",e)}}function Be(){try{const e=Ie();return e&&"none"!==e.style.display}catch(e){return console.warn("[messageDisplay] isVisible error:",e),!1}}function Ae(e,t){window?.DEBUG_MODE&&console.debug(`[MESSAGE ANALYTICS] ${e}`,t)}e&&"function"==typeof e.subscribe&&(e.subscribe("playerDefeated",(({winner:e,loser:t})=>{Se(`${e} defeated ${t}!`,{critical:!0,duration:3e3}),Ae("playerDefeated",{winner:e,loser:t})})),e.subscribe("powerupCollected",(({player:e,powerup:t})=>{Se(`${e.name||"Player"} collected a ${t.type} powerup!`),Ae("powerupCollected",{player:e,powerup:t})})),e.subscribe("pause",(()=>{Se("Paused",{duration:0}),Ae("pause")})),e.subscribe("resume",(()=>{Le(),Ae("resume")})),e.subscribe("settingsChanged",(()=>{Se("Settings updated!",{duration:1200}),Ae("settingsChanged")})),e.subscribe("diagnostic",(({event:e,data:t})=>{window?.DEBUG_MODE&&Se(`[DIAGNOSTIC] ${e}`,{duration:1200}),Ae("diagnostic",{event:e,data:t})}))),document.addEventListener("keydown",(e=>{"Escape"===e.key&&Be()&&Le()}));const He={};function Te(e,t){He[e]&&He[e].forEach((n=>{try{n(t)}catch(t){console.error(`[messageDisplay] Error in custom event listener for ${e}:`,t)}}))}const Ue=[];let ke=!1;function Ne(e,t={}){try{Ue.push({message:e,opts:t}),$e()}catch(e){console.warn("[messageDisplay] queueMessage error:",e)}}function $e(){try{if(ke||0===Ue.length)return;const{message:e,opts:t}=Ue.shift();ke=!0,Se(e,{...t,onHide:()=>{ke=!1,$e()}})}catch(e){console.warn("[messageDisplay] processMessageQueue error:",e),ke=!1}}function Pe(e,t={}){try{Se(e,{...t,duration:0})}catch(e){console.warn("[messageDisplay] showPersistentMessage error:",e)}}let Ge=null;const _e=[];let Oe,Fe;function Re(e){if(!Fe)return;const t=document.createElement("li");t.textContent=e,Fe.appendChild(t),Fe.childElementCount>100&&Fe.removeChild(Fe.firstChild),Oe.scrollTop=Oe.scrollHeight}window.messageDisplayDebug={...window.messageDisplayDebug,queueMessage:Ne,showPersistentMessage:Pe,flashMessage:function(e,t={}){try{const n=Ie();n&&"none"!==n.style.display&&(Ge=n.textContent),Se(e,{...t,duration:t.duration||1e3}),setTimeout((()=>{try{Ge&&(Pe(Ge),Ge=null)}catch(e){console.warn("[messageDisplay] flashMessage restore error:",e)}}),t.duration||1e3)}catch(e){console.warn("[messageDisplay] flashMessage error:",e)}},getMessageHistory:function(){try{return[..._e]}catch(e){return console.warn("[messageDisplay] getMessageHistory error:",e),[]}},clearAllMessages:function(){try{Ue.length=0,Le()}catch(e){console.warn("[messageDisplay] clearAllMessages error:",e)}},setMessageStyle:function(e={}){try{const t=Ie();if(!t)throw new Error("Message container not found");Object.entries(e).forEach((([e,n])=>{t.style[e]=n}))}catch(e){console.warn("[messageDisplay] setMessageStyle error:",e)}},setMessageIcon:function(e){try{const t=Ie();if(!t)throw new Error("Message container not found");t.innerHTML=e+'<span class="msg-text">'+t.textContent+"</span>"}catch(e){console.warn("[messageDisplay] setMessageIcon error:",e)}},announceMessageSR:function(e){try{const t=Ie();if(!t)throw new Error("Message container not found");t.setAttribute("aria-live","assertive"),t.textContent=e,setTimeout((()=>t.setAttribute("aria-live","polite")),1e3)}catch(e){console.warn("[messageDisplay] announceMessageSR error:",e)}},messageQueue:Ue,messageHistory:_e},window.messageDisplayUI={showMessage:Se,hideMessage:Le,setCritical:function(e=!0){try{const t=Ie();if(!t)throw new Error("Message container not found");e?t.classList.add("critical"):t.classList.remove("critical")}catch(e){console.warn("[messageDisplay] setCritical error:",e)}},isVisible:Be,queueMessage:Ne,dispatchMessageEvent:function(e,t={}){try{Te(e,t),Ae("eventDispatched",{eventType:e,detail:t})}catch(t){console.error(`[messageDisplay] Error dispatching event (${e}):`,t)}},onMessageEvent:function(e,t){"string"==typeof e&&"function"==typeof t&&(He[e]||(He[e]=[]),He[e].push(t))},offMessageEvent:function(e,t){He[e]&&(He[e]=He[e].filter((e=>e!==t)))}},n((e=>{const t=document.getElementById("messageDisplay");t&&(t.style.display="MENU"===e||"END"===e?"block":"none")})),Oe=document.createElement("div"),Oe.id="debugPanel",Object.assign(Oe.style,{position:"absolute",bottom:"0",left:"0",width:"320px",maxHeight:"40%",background:"rgba(0,0,0,0.8)",color:"#0f0",fontFamily:"monospace",fontSize:"12px",overflowY:"auto",padding:"4px",zIndex:"10000",display:"none"}),document.body.appendChild(Oe),Fe=document.createElement("ul"),Fe.style.margin=0,Fe.style.padding="0 4px",Fe.style.listStyle="none",Oe.appendChild(Fe),window.addEventListener("keydown",(t=>{"`"===t.key&&(Oe.style.display="none"===Oe.style.display?"block":"none",e.enableDebug())})),e.subscribe("frame",(({delta:e})=>{Re(`[FRAME] Î”=${e.toFixed(2)}ms`)})),e.subscribe("diagnostic",(({event:e,data:t})=>{Re(`[DIAG] ${e}`)})),e.subscribe("playerHit",(({defender:e,attacker:t})=>{Re(`[HIT] P${t.playerIndex+1} -> P${e.playerIndex+1}`)})),o("eventManager",e),o("aiControllers",r.aiControllers),o("obstacles",r.obstacles),o("powerups",r.powerups),o("hitSparks",r.hitSparks);let je=!1;function qe(t,n={}){if(c&&"PLAYING"!==c())return;if("number"!=typeof t||t<=0)return;!function(t){e.debugMode&&console.debug("[gameLoop] integratedGameLoop called, delta:",t)}(t);const o={...r,...n};if(o.delta=t,"MENU"!==o.menuState&&"END"!==o.menuState||(je=!1),u?.(t,o),d?.(t,o),h?.(t,o),p?.(t,o),f?.(t,o),!je&&Array.isArray(o.players)&&o.players.length>=2){const[t,n]=o.players;if(t.health<=0||n.health<=0){je=!0;const o=t.health>n.health?t:n,r=o===t?n:t;e.dispatchEvent("playerDefeated",{winner:o,loser:r}),e.dispatchEvent("gameOver",{winner:o,loser:r}),e.dispatchEvent("fightEnd",{winner:o,loser:r})}}o.ctx&&(y(o.ctx),s().forEach((e=>{try{e.draw(o.ctx)}catch(e){console.error("[gameLoop] Error drawing stickman:",e)}})),m(o.ctx),g(o.ctx)),b("frame",{time:Date.now(),context:o}),e?.dispatchEvent("frame",{delta:t,context:o})}e&&"function"==typeof e.subscribe&&(e.subscribe("diagnostic",(({event:e,data:t})=>{window?.DEBUG_MODE&&console.debug(`[DIAGNOSTIC] ${e}:`,t)})),e.subscribe("frame",(({delta:e,context:t})=>{window?.DEBUG_MODE&&window?.DEBUG_FRAME_LOG&&console.debug(`[FRAME] delta=${e}`,t)}))),e&&"function"==typeof e.subscribe&&(e.subscribe("playerHit",(({defender:e})=>{R(e)})),e.subscribe("playerHealed",(({player:e})=>{R(e)})),e.subscribe("powerupCollected",(({player:e,powerup:t})=>{Se(`${e.name||"Player"} collected a ${t.type} powerup!`)})),e.subscribe("playerDefeated",(({winner:e,loser:t})=>{Se(`${e} defeated ${t}!`),ce("end")})),e.subscribe("pause",(()=>ce("pause"))),e.subscribe("resume",(()=>ce("resume")))),e&&"function"==typeof e.subscribe&&(e.subscribe("comboAchieved",(({player:e,comboCount:t})=>{if(t>3)for(const e of a)e.setBehavior("aggressive")})),e.subscribe("playerStreak",(({player:e,streak:t})=>{if(t>2)for(const e of a)e.setBehavior("defensive")}))),e&&"function"==typeof e.subscribe&&e.subscribe("settingsChanged",(({settings:e})=>{T()})),e.subscribe("saveGame",(()=>{const e=s().map(((e,t)=>({index:t,x:e.x,y:e.y,health:e.health,facingRight:e.facingRight})));i({players:e})})),e.subscribe("loadGame",(()=>{const t=l();t&&Array.isArray(t.players)&&t.players.forEach((t=>e.dispatchEvent("loadPlayerState",t)))})),e.subscribe("pause",(()=>e.dispatchEvent("saveGame"))),e.subscribe("fightEnd",(()=>e.dispatchEvent("saveGame"))),e.dispatchEvent("loadGame",{}),window.eventManager=e,window.addEventListener("DOMContentLoaded",(()=>{console.log("[StickFighter] Page loaded - JS bundle is running.");try{let t=!1;w("MENU"),v(),n(v),e.subscribe("showMenu",(({state:e})=>w(e||"MENU"))),e.subscribe("menuStart",(()=>{w("PLAYING"),window.menuUI?.hideMenu(),r.players.length=0;const n=document.getElementById("gameCanvas"),o=new E(100,n.height-50,{},!0,null,!1);o.playerIndex=0;const a=new E(n.width-100,n.height-50,{},!1,null,!1);a.playerIndex=1,r.players.push(o,a),e.dispatchEvent("fightStart",{players:r.players});let s=performance.now();requestAnimationFrame((function e(o){const r=o-s;if(s=o,n){const e=n.getContext("2d");e.clearRect(0,0,n.width,n.height),e.fillStyle="#111",e.fillRect(0,0,n.width,n.height),t||qe(r,{ctx:e,canvasHeight:n.height})}requestAnimationFrame(e)}))})),e.subscribe("pause",(()=>{t=!0,w("PAUSED")})),e.subscribe("resume",(()=>{t=!1,w("PLAYING")})),e.subscribe("gameOver",(()=>w("END"))),e.subscribe("fightStart",(()=>w("PLAYING"))),e.subscribe("fightEnd",(()=>w("END"))),e.subscribe("menuMainMenu",(()=>w("MENU"))),e.subscribe("settingsMenu",(()=>w("SETTINGS_MENU"))),window.addEventListener("keydown",(n=>{"Escape"===n.key&&(t?(e.dispatchEvent("resume"),w("PLAYING"),window.menuUI?.hideMenu()):(e.dispatchEvent("pause"),w("PAUSED"),window.menuUI?.updateMenuState("PAUSED")),t=!t)})),window.healthBarUI?.renderHealthBars(),window.controlsInfoUI?.renderControlsInfo(),window.menuUI?.renderMenu(),window.messageDisplayUI?.showMessage("Welcome to Stick Fighter!");const o=document.getElementById("resetButton");o&&o.addEventListener("click",(()=>{try{e.dispatchEvent("menuMainMenu",{}),window.menuUI?.updateMenuState("MENU"),window.healthBarUI?.hideHealthBars(),window.messageDisplayUI?.hideMessage();const t=document.getElementById("pauseMenuTitle");t&&(t.style.display="none");const n=document.getElementById("settingsMenuTitle");n&&(n.style.display="none")}catch(e){console.warn("[index.js] Error in resetButton handler:",e)}})),e.subscribe("frame",(({context:e})=>{window.healthBarUI&&Array.isArray(e.players)&&e.players.forEach((e=>{try{window.healthBarUI.updateHealthBar(e)}catch(e){console.error("[index.js] Error updating health bar on frame:",e)}}))})),e.subscribe("showMenu",(({state:e})=>w(e||"MENU"))),window?.DEBUG_MODE&&console.debug("[index.js] UI/game bootstrapped successfully");const a=new CustomEvent("stickFighterAppReady",{detail:{modules:window.stickFighterDebug}});window.dispatchEvent(a)}catch(e){console.error("[index.js] Error during UI/game bootstrapping:",e),window.messageDisplayUI?.showMessage("Critical error during startup. See console for details.",{critical:!0,duration:0})}})),window.stickFighterDebug={menu:window.menuUI,healthBar:window.healthBarUI,controlsInfo:window.controlsInfoUI,messageDisplay:window.messageDisplayUI,onAppReady:e=>window.addEventListener("stickFighterAppReady",e),triggerError:(e="Manual test error")=>{throw new Error(e)}},window.addEventListener("error",(e=>{console.error("[Global Error]",e.message,e.error),window.messageDisplayUI?.showMessage("A global error occurred. See console for details.",{critical:!0,duration:0})})),window.addEventListener("unhandledrejection",(e=>{console.error("[Global Unhandled Promise Rejection]",e.reason),window.messageDisplayUI?.showMessage("A promise error occurred. See console for details.",{critical:!0,duration:0})}));
//# sourceMappingURL=index-25fb385f.js.map
